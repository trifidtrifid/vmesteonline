define("products",["jquery","shop-initThrift","bo-common"],function(a,b,c){function d(){function d(a){var c;r?c=r:r=c=b.client.getAllCategories(s);var d=c.length,e="";if(a){for(var f,g=0;d>g;g++)c[g].id==a&&(f=c[g]);return f}for(var g=0;d>g;g++)e+='<li data-categoryid="'+c[g].id+'"><a href="#">'+c[g].name+"</a></li>";var h='<div class="btn-group categories-dropdown"><button data-toggle="dropdown" class="btn btn-info btn-sm dropdown-toggle no-border"><span class="btn-group-text">Добавить</span><span class="icon-caret-down icon-on-right"></span></button><ul class="dropdown-menu dropdown-blue">'+e+"</ul></div>";return h}function i(){function f(b,c){var d=new com.vmesteonline.be.shop.FullProductInfo;d.product=new com.vmesteonline.be.shop.Product,d.details=new com.vmesteonline.be.shop.ProductDetails,d.product.id=c?0:b.closest("tr").attr("id"),d.product.name=b.find(".product-name textarea").val(),d.product.shortDescr=b.find(".product-shortDescr textarea").val(),d.product.producerId=b.find(".product-producer").data("producerid");var e=b.find(".product-imageURL .file-name img");d.product.imageURL=e.length?e.css("background-image"):b.find(".product-imageURL>img").attr("src"),d.product.weight=b.find(".product-weight input").val()?parseFloat(b.find(".product-weight input").val()):0,d.details.pricesMap=[],d.details.pricesMap[1]=b.find(".product-price input").val()?parseFloat(b.find(".product-price input").val()):0,d.product.unitName=b.find(".product-unitName input").val(),d.product.minClientPack=b.find(".product-pack input").val()?parseFloat(b.find(".product-pack input").val()):0,d.product.prepackRequired=b.find(".product-prepack input").attr("checked")?!0:!1,d.details.fullDescr=b.find(".product-fullDescr textarea").val();var f=0,g=b.find(".product-imagesSet").find(".file-name img").length;if(g){var h=[];b.find(".product-imagesSet .ace-file-input.added").each(function(){h[f++]=a(this).find(".file-name img").css("background-image")}),d.details.imagesURLset=h}f=0;var i=[];b.find(".product-categories .category-item").each(function(){i[f++]=a(this).data("categoryid")}),d.details.categories=i;var j=[];b.find(".product-options table tr").each(function(){j[a(this).find("td:eq(0)").text()]=a(this).find("td:eq(1)").text()}),d.details.options=j;var k=[];return b.find(".product-links>table>tbody>tr").each(function(){var b=a(this).find("input").val(),c=a(this).find(".link-key").text();k[c]=b}),d.details.socialNetworks=k,d}function g(c){{var e;a(".products-table>table")}c.click(function(){var f=a(this).attr("id");q[f]?e=q[f]:(e=b.client.getProductDetails(f),q[f]=e),a(this).find(".modal").modal(),c.find(".modal-editProduct .close").click(function(b){b.preventDefault(),b.stopPropagation(),a(this).closest(".modal").modal("hide")}),c.find(".modal-editProduct").click(function(b){b.stopPropagation(),a(this).find(".categories-dropdown").hasClass("open")&&a(this).find(".categories-dropdown").removeClass("open"),a(this).find(".producers-dropdown").hasClass("open")&&a(this).find(".producers-dropdown").removeClass("open")});var g=e.imagesURLset,h=g.length,p="<div class='images-set'>";if(0!=h)for(var r=0;h>r;r++)p+="<div class='image-item map-item'><a href='#' class='remove-image-item remove-item'>&times</a><img src='"+g[r]+"'></div>";p+="</div><input type='file' id='imagesURLSet-"+f+"-"+h+"'>";for(var s=e.categories,v=s.length,w="",r=0;v>r;r++)w+="<div class='category-item map-item' data-categoryid='"+s[r]+"'><a href='#' class='remove-category-item remove-item'>&times</a>"+d(s[r]).name+"</div>";w+=t;var x=e.optionsMap,y="<table><tbody>";for(var z in x)y+="<tr><td><input type='text' value='"+z+"'></td><td><input type='text' value='"+x[z]+"'></td><td class='td-remove-options'><a href='' class='remove-options-item remove-item'>&times;</a></td></tr>";y+="</tbody></table><a href='#' class='add-options-item add-item'>Добавить</a>";var A=e.socialNetworks,B=a(this).find(".product-links");for(var z in A)"vk"==z?B.find("tr:eq(0) td:eq(1) input").val(A[z]):"fb"==z&&B.find("tr:eq(1) td:eq(1) input").val(A[z]);for(var C,D=a(this).find(".product-producer").data("producerid"),E=u,F=E.length,G="",r=0;F>r;r++)E[r].id==D&&(C=E[r]),G+="<li data-producerid='"+E[r].id+"'><a href='#'>"+E[r].name+"</a></li>";var H="<span>"+C.name+'</span><div class="btn-group producers-dropdown"><button data-toggle="dropdown" class="btn btn-info btn-sm dropdown-toggle no-border"><span class="btn-group-text">Изменить</span><span class="icon-caret-down icon-on-right"></span></button><ul class="dropdown-menu dropdown-blue">'+G+"</ul></div>",I=a(this);a("#imageURL-"+f).ace_file_input({style:"well",btn_choose:"",btn_change:null,no_icon:"",droppable:!0,icon_remove:null,thumbnail:"large"}).on("change",function(){I.find(".product-imageURL .file-label").css("opacity",1),I.find(".product-imageURL>img").hide()}),a(this).find(".product-fullDescr textarea").val(e.fullDescr);for(var z in e.pricesMap)"1"==z&&a(this).find(".product-price input").val(e.pricesMap[z]);a(this).find(".product-imagesSet").html(p),a("#imagesURLSet-"+f+"-"+h).ace_file_input({style:"well",btn_choose:"Добавить",btn_change:null,no_icon:"",droppable:!0,thumbnail:"large"}).on("change",function(){var b=a(this);k(f,h,b)}),j(a(this).find(".ace-file-input")),a(this).find(".product-categories").html(w),l(a(this)),m(a(this)),a(this).find(".product-options").html(y),n(a(this)),o(a(this)),a(this).find(".product-producer").html(H),i(a(this))})}function h(c){var d;d=c?c:a(".product-remove a"),d.click(function(c){c.preventDefault(),c.stopPropagation();var d=a(this).closest("tr").attr("id"),e=a(".backoffice.dynamic").attr("id");a(this).closest("tr").addClass("removing").fadeOut(600,function(){a(this).detach()}),b.clientBO.deleteProduct(d,e)})}function i(b){b.find(".producers-dropdown .btn").click(function(b){b.stopPropagation(),a(this).closest(".modal").length&&(a(this).closest(".producers-dropdown").hasClass("open")?a(this).closest(".producers-dropdown").removeClass("open"):a(this).closest(".producers-dropdown").addClass("open"))}),b.find(".producers-dropdown .dropdown-menu a").click(function(b){b.preventDefault();var c=a(this).text(),d=a(this).closest("li").data("producerid");a(this).closest(".edit-product-item").attr("id",d).find(">span").text(c),a(this).closest(".producers-dropdown").removeClass("open")})}var p=a(".products-table>table");p.find(">tbody>tr").each(function(){g(a(this))}),c.DoubleScroll(document.getElementById("doublescroll-2")),a(".table-add-product .edit-add").click(function(c){c.preventDefault();var d=a(".backoffice.dynamic").attr("id"),e=a(this).closest(".table-add-product").find("ul"),i=!0,j=f(e,i);if(j.product.producerId){a(".error-info").hide();var k=b.clientBO.registerProduct(j,d);a(".table-add-product .modal").modal("hide"),a(this).closest(".table-add-product").slideUp(function(){var b=(e.clone(),'<tr class="new" id="'+k+'"><td class="product-name">'+e.find(".product-name textarea").val()+'<div class="modal modal-editProduct"><div class="modal-body"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h3>Редактирование продукта</h3><ul class="edit-product-list clearfix"><li><label>Название</label><span class="edit-product-item product-name"><textarea>'+e.find(".product-name textarea").val()+'</textarea></span></li><li><label>Сокр. описание</label><span class="edit-product-item product-shortDescr"><textarea>'+e.find(".product-shortDescr textarea").val()+'</textarea></span></li><li><label>Полное описание</label><span class="edit-product-item product-fullDescr"><textarea>'+e.find(".product-fullDescr textarea").val()+'</textarea></span></li><li class="pull-left short1"><label>Аватар</label><span class="edit-product-item product-imageURL"><input type="file" id="imageURL-'+k+'">');b+=e.find(".product-imageURL .file-label img").length?'<img src="'+e.find(".product-imageURL .file-label img").attr("src")+'" alt="картинка"/>':'<img src="../i/no-photo.png" alt="картинка"/>',b+='</span></li><li class="pull-left short1"><label>Другие изображения</label><span class="edit-product-item product-imagesSet"><input type="file" id="imagesSetURL"></span></li><li class="pull-left short1 clear"><label>Категории</label><span class="edit-product-item product-categories"></span></li><li class="pull-left short1"><label>Производитель</label><span class="edit-product-item product-producer" data-producerid="'+e.find(".product-producer").attr("data-producerid")+'"></span></li><li class="pull-left short2 clear"><label>Вес</label><span class="edit-product-item product-weight"><input type="text" value="'+e.find(".product-weight input").val()+'"/></span></li><li class="pull-left short2"><label>Цена</label><span class="edit-product-item product-price"><input type="text" value=""/></span></li><li class="pull-left short2"><label>Ед.изм</label><span class="edit-product-item product-unitName"><input type="text" value="'+e.find(".product-unitName input").val()+'"/></span></li><li class="pull-left short2"><label>Мин.шаг</label><span class="edit-product-item product-pack"><input type="text" value="'+e.find(".product-pack input").val()+'"/></span></li><li class="pull-left short2"><label>Весовой</label><span class="edit-product-item product-prepack">',b+=e.find(".product-prepack input").prop("checked")?'<input type="checkbox" checked />':'<input type="checkbox" />',b+='</span></li><li class="pull-left short1 clear"><label>Опции</label><span class="edit-product-item product-options"></span></li><li class="pull-left short1"><label>Ссылки</label><span class="edit-product-item product-links"><table><tbody><tr><td class="link-key">vk</td><td><input type="text"/></td></tr><tr><td class="link-key">fb</td><td><input type="text"/></td></tr></tbody></table></span></li></ul><a class="btn btn-sm btn-primary no-border save-products clear" href="#">Сохранить</a></div></div></td><td class="product-shortDescr">'+e.find(".product-shortDescr textarea").val()+'</td><td class="product-imageURL">',b+=e.find(".product-imageURL .file-label img").length?'<img src="'+e.find(".product-imageURL .file-label img").attr("src")+'" alt="картинка"/>':'<img src="../i/no-photo.png" alt="картинка"/>',b+='</td><td class="product-weight">'+e.find(".product-weight input").val()+'</td><td class="product-unitName">'+e.find(".product-unitName input").val()+'</td><td class="product-pack">'+e.find(".product-pack input").val()+'</td><td class="product-prepack">',b+=e.find(".product-prepack input").prop("checked")?'<input type="checkbox" checked />':'<input type="checkbox" />',b+='</td><td class="product-remove"><a href="#" title="Удалить" class="remove-item">&times;</a></td></tr>',a(".products-table>table>tbody").prepend(b),g(a(".products-table>table>tbody .new")),h(a(".products-table>table>tbody .new .product-remove")),a(".products-table>table>tbody .new").removeClass("new")})}else a(".error-info").text("Вы не указали производителя !").show()});var q=[];h(),a(".save-products").click(function(c){c.preventDefault();var d=a(this).closest(".modal-body").find(".edit-product-list"),e=!1,g=f(d,e);(void 0===g.imageURL||"/i/no-photo.png"==g.imageURL)&&(g.imageURL=null),b.clientBO.updateProduct(g),a(this).closest(".modal").modal("hide")}),a("#edit-product .products-table table tr,#edit-category .category-table tr,#edit-producer .producer-table tr").click(function(){a(this).addClass("changed")}),e=1}function j(b){b.find(".remove").click(function(b){b.preventDefault(),a(this).closest(".ace-file-input").hide().detach()})}function k(b,c,d){if(!d.parent().hasClass("added")){d.parent().addClass("added"),c++;var e="<input type='file' class='new-input' id='imagesURLSet-"+b+"-"+c+"'>";d.parent().after(e),a("#imagesURLSet-"+b+"-"+c).ace_file_input({style:"well",btn_choose:"Добавить",btn_change:null,no_icon:"",droppable:!0,thumbnail:"large"}).on("change",function(){var d=a(this);k(b,c,d)}),j(d.parent())}}function l(b){b.find(".remove-category-item").click(function(b){b.preventDefault(),a(this).closest(".map-item").fadeOut(200)})}function m(b){b.find(".categories-dropdown .btn").click(function(b){b.stopPropagation(),a(this).closest(".categories-dropdown").hasClass("open")?a(this).closest(".categories-dropdown").removeClass("open"):a(this).closest(".categories-dropdown").addClass("open")}),b.find(".categories-dropdown .dropdown-menu a").click(function(b){b.preventDefault(),b.stopPropagation();var c='<div class="category-item map-item" data-categoryid="'+a(this).closest("li").data("categoryid")+'"><a href="#" class="remove-category-item remove-item">×</a>'+a(this).text()+"</div>";a(this).closest("td").find(".categories-dropdown").before(c),a(this).closest(".categories-dropdown").removeClass("open"),l(a(this).closest("td"))})}function n(b){b.find(".remove-options-item").click(function(b){b.preventDefault(),b.stopPropagation(),a(this).closest("tr").slideUp(200,function(){a(this).detach()})})}function o(b){b.find(".add-options-item").click(function(b){b.preventDefault(),b.stopPropagation();var c='<tr><td><input type="text" value=""></td><td><input type="text" value=""></td><td class="td-remove-options"><a href="" class="remove-options-item remove-item">×</a></td></tr>';a(this).closest(".product-options").find("table tbody").append(c),n(a(this).closest(".product-options"))})}function p(){function c(a){var b=a.text(),c=a.closest("li").data("categoryid");a.closest(".category-parent").attr("data-parentid",c).find(".btn-group-text").text(b)}function d(b,c){var d=new com.vmesteonline.be.shop.ProductCategory;return d.id=c?0:b.attr("id"),d.name=b.find(".category-name textarea").val(),d.descr=b.find(".category-descr textarea").val(),d.parentId=b.find(".category-parent").attr("data-parentid"),d.socialNetworks=[],b.find(".category-links table tr").each(function(){var b=a(this).find("input").val(),c=a(this).find(".link-key").text();d.socialNetworks[c]=b}),d}for(var e=a(".backoffice.dynamic").attr("id"),g=b.client.getAllCategories(e),h=g.length,i=[],j=0,k=0;h>k;k++)i[k]=g[k].socialNetworks;i.length&&a(".category-table>tbody>tr").each(function(){var b=i[j];for(var c in b)"vk"==c?a(this).find(".category-links tr:eq(0) td:eq(1) input").val(b[c]):"fb"==c&&a(this).find(".category-links tr:eq(1) td:eq(1) input").val(b[c]);j++}),a(".category-parent").each(function(){if(a(this).html(t),a(this).find(".btn-group-text").text("Выбрать родительскую"),a(this).find(".dropdown-menu a").click(function(b){b.preventDefault(),c(a(this))}),0==a(this).closest(".table-add").length){var b=a(this).data("parentid");a(this).find(".dropdown-menu li").each(function(){a(this).data("categoryid")==b&&c(a(this))})}}),a(".table-add-category .edit-add").click(function(c){c.preventDefault();var e=a(".backoffice.dynamic").attr("id"),f=a(this).closest(".table-add-category").find(">table>tbody>tr"),g=!0,h=d(f,g);a(".error-info").hide(),b.clientBO.registerProductCategory(h,e),a(this).closest(".table-add-category").slideUp(function(){var b=f.clone();a(".category-table>tbody").prepend(b),b.slideDown()})}),a(".save-categories").click(function(c){c.preventDefault(),a(".category-table>tbody>tr.changed").each(function(){var c=a(this),e=!1,f=d(c,e);b.clientBO.updateCategory(f)})}),a(".category-remove a").click(function(c){c.preventDefault();var d=a(this).closest("tr").attr("id"),e=a(".backoffice.dynamic").attr("id");a(this).closest("tr").addClass("removing").fadeOut(600,function(){a(this).detach()}),b.clientBO.deleteCategory(d,e)}),f=1}function q(){function c(b,c){var d=new com.vmesteonline.be.shop.Producer;return d.id=c?0:b.attr("id"),d.name=b.find(".producer-name textarea").val(),d.descr=b.find(".producer-descr textarea").val(),d.socialNetworks=[],b.find(".producer-links table tr").each(function(){var b=a(this).find("input").val(),c=a(this).find(".link-key").text();d.socialNetworks[c]=b}),d}for(var d=(a(".backoffice.dynamic").attr("id"),b.client.getProducers()),e=d.length,f=[],h=0,i=0;e>i;i++)f[i]=d[i].socialNetworks;f.length&&a(".producer-table>tbody>tr").each(function(){var b=f[h];for(var c in b)"vk"==c?a(this).find(".producer-links tr:eq(0) td:eq(1) input").val(b[c]):"fb"==c&&a(this).find(".producer-links tr:eq(1) td:eq(1) input").val(b[c]);h++}),a(".table-add-producer .edit-add").click(function(d){d.preventDefault();var e=a(".backoffice.dynamic").attr("id"),f=a(this).closest(".table-add-producer").find(">table>tbody>tr"),g=!0,h=c(f,g);a(".error-info").hide(),b.clientBO.registerProducer(h,e),a(this).closest(".table-add-producer").slideUp(function(){var b=f.clone();a(".producer-table >tbody").prepend(b),b.slideDown()})}),a(".save-producers").click(function(d){d.preventDefault(),a(".producer-table>tbody>tr.changed").each(function(){var d=a(this),e=!1,f=c(d,e);b.clientBO.updateProducer(f)})}),a(".producer-remove a").click(function(c){c.preventDefault();var d=a(this).closest("tr").attr("id"),e=a(".backoffice.dynamic").attr("id");a(this).closest("tr").addClass("removing").fadeOut(600,function(){a(this).detach()}),b.clientBO.deleteProducer(d,e)}),g=1}var r,s=a(".backoffice.dynamic").attr("id"),t=d(),u=b.client.getProducers();e||i(),h||(a(".edit-show-add").click(function(b){b.preventDefault(),a(this).find("+.table-add").slideToggle();var c=a(this).closest(".tab-pane").attr("id");switch(c){case"edit-product":a(".table-add-product .modal-editProduct").modal();var d=a(".table-add-product ul");a("#imageURL-add").ace_file_input({style:"well",btn_choose:"",btn_change:null,no_icon:"",droppable:!0,icon_remove:null,thumbnail:"large"}).on("change",function(){d.find(".product-imageURL .file-label").css("opacity",1),d.find(".product-imageURL>img").hide()}),a("#imageURLSet-add").ace_file_input({style:"well",btn_choose:"Добавить",btn_change:null,no_icon:"",droppable:!0,thumbnail:"large"}).on("change",function(){var b=a(this);k(0,0,b)}),j(a(".table-add-product .product-imagesSet"));var e=t,f=a(".table-add-product .product-categories");f.html(e),l(f),m(f);{var g=(a(".table-add-product .table-overflow"),a(".table-add-product .product-options"));a(".table-add-product .product-links")}n(g),o(g),a(this).find("+.table-add .product-producer .dropdown-menu a").click(function(){var b=a(this).parent().data("producerid");a(this).closest(".edit-product-item").attr("data-producerid",b)});break;case"edit-category":break;case"edit-producer":}}),a(".bo-edit .nav-tabs a").click(function(){function b(){c.setSidebarHeight(a(".main-content").height())}var d=a(this).parent().index();switch(d){case 1:f||p();break;case 2:g||q()}setTimeout(b,200)})),h=1}var e=0,f=0,g=0,h=0;return{initEdit:d,isEditInitSet:h}});