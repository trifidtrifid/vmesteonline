define("shop-basket",["jquery","shop-initThrift","shop-spinner","shop-common","shop-search","shop-orders","bootbox"],function(a,b,c,d,e,f){function g(){var b=require("shop-common");if(b.remarkAddedProduct(),a(".tab-pane").length>1){var c=a(".tabs-days").find(".nav li.active"),d=a(".tab-pane.active");d.removeClass("active").next().addClass("active"),d.hide().remove(),c.removeClass("active").next().addClass("active"),c.hide().remove()}else a(".tabs-days").hide().remove()}function h(c,d){c.click(function(e){function f(c,e,f){c.closest(".product").slideUp(function(){var c=a(this).data("productid");a(".catalog").find(".added").each(function(){a(this).data("productid")==c&&a(this).removeClass("added")});var g=require("shop-common");h&&(i=d?d:b.client.getOrderDetails(k),a(".tabs-days .tab-content .catalog-order").find(".product").each(function(){a(this).data("productid")==c&&a(this).css("display","none").detach()}),a(".itogo-right span").text(g.countAmount(j.find(".catalog-order"),i))),a(this).detach(),b.client.removeOrderLine(k,a(this).closest(".product").data("productid")),i=b.client.getOrderDetails(k),j.find(".amount span").text(g.countAmount(j.find(".catalog-order"),i));var m=g.getOrderWeight(k,i);j.find(".weight span").text(m),a(".weight-right span").text(m),e&&(j.closest(".tabs-days").hide().remove(),b.client.deleteOrder(k)),f&&l.trigger("click")})}e.preventDefault();var g,h,i,j=a(".tab-pane.active"),k=j.data("orderid");h=a(this).closest(".confirm-order").length>0,g=h?a(this).closest(".catalog-confirm").find(".product"):c.closest(".catalog-order").find(".product");var l=a(this).closest(".confirm-order").find(".additionally-order .btn-cancel");if(1==g.length)if(h){var m=a(this);bootbox.confirm("Вы действительно хотите отменить заказ ?",function(a){if(a){var b=!0,c=!0;f(m,b,c)}})}else{var n=!0;f(a(this),n)}else f(a(this))})}function i(c){c.click(function(c){c.preventDefault();var d=!1;if(globalUserAuth){var e=a(this).closest(".product"),f=e.find(".td-spinner .ace-spinner").spinner("value"),g={id:e.data("productid"),imageURL:e.find(".product-link img").attr("src"),name:e.find(".product-name").text(),price:e.find(".product-price").text(),unitName:e.find(".unit-name").text(),producerName:e.find(".td-producer").text(),producerId:e.find(".td-producer").data("producerid"),minClientPack:e.find(".td-spinner .ace-spinner .spinner1").data("step"),prepackLine:e.find(".prepack-line"),prepackRequired:e.data("prepack"),qnty:f,packVal:1,quantVal:e.find(".td-spinner .spinner1").data("step")},h=[];if(g.prepackRequired){g.quantVal=f;var i=e.find(".modal-body").length>0;if(i){var k=e.find(".packs:eq(0) .ace-spinner").spinner("value"),l=e.find(".qnty .ace-spinner").eq(0).spinner("value");if(g.packVal=k,g.quantVal=l,g.qnty=k*l,h[l]=k,0!=g.prepackLine.length){var m=0,n=a(".modal-footer.with-prepack>.qnty .ace-spinner").spinner("value");g.prepackLine.each(function(){k=a(this).find(".packs .ace-spinner").spinner("value"),l=a(this).find(".qnty .ace-spinner").spinner("value"),(l==m||l==n)&&(e.find(".error-prepack").text("Товар не возможно добавить: вы создали две линни с одинаковым количеством продукта").show(),d=!0),h[l]=k,g.qnty+=k*l,m=l})}}else{var o=a(this).closest(".order-item").length>0;if(o)for(var p=a(this).closest(".order-item").data("orderid"),r=b.client.getOrderDetails(p),s=r.odrerLines,t=s.length,u=0;t>u;u++)s[u].product.id==a(this).closest(".product").data("productid")&&(h=s[u].packs);else h[g.qnty]=1,g.packsQnty=1}}else h=0;d||(0==a(".tabs-days").length?j(!0,0,null,g,h,r,e):(q(g,h),e.addClass("added")));var v=a(this).closest(".modal").length>0;v&&!d&&(a(this).closest(".modal").find(".close").trigger("click"),e.find(".error-prepack").hide())}else{z=a(this);var w=require("shop-common");w.openModalAuth()}})}function j(b,c,d,e,f,g,h,i){a(".modal-chooseDate").modal(),a(".datepicker-chooseDate").datepicker({language:"ru"}),b?k(b,c,e,f,g,h,i):(a(".chooseDate").attr("data-date",d.date).text(d.text),k(b,c,e,f,g,h))}function k(c,d,e,f,g,h,i){a(".create-order-btn").one("click",function(j){j.preventDefault();var k=a(".chooseDate").attr("data-date");if(c){var n=b.client.createOrder(k);if(g=b.client.getOrderDetails(n.id),m(n.date,n.id,g),i){var o=require("shop-orders");o.addOrderTo(d,i,g)}else q(e,f),h.addClass("added")}else{b.client.updateOrder(d,k);var p=new Date(1e3*k),r=p.getDay(),s=a(".tabs-days .nav-tabs a");s.html(l(r)+"<span>"+a(".chooseDate").text()+"</span>"),a(".order-date").html("Заказ на <span>"+a(".chooseDate").text()+" ("+l(r)+")</span>")}a(".modal-chooseDate").modal("hide")})}function l(a){var b;switch(a){case 0:b="ВС";break;case 1:b="ПН";break;case 2:b="ВТ";break;case 3:b="СР";break;case 4:b="ЧТ";break;case 5:b="ПТ";break;case 6:b="СБ"}return b}function m(c,d,e){var f=new Date(1e3*c),h=f.getDate(),i=f.getDay(),k=f.getMonth()+1;if(h=10>h?"0"+h:h,k=10>k?"0"+k:k,i=l(i),0==a(".tabs-days").length){var m='<div class="tabbable tabs-right tabs-days"><ul class="nav nav-tabs" id="myTab3"><li class="active"><a data-toggle="tab" data-date="'+c+'" href="#day'+h+k+'">'+i+"<span>"+h+"."+k+'</span></a></li></ul><div class="tab-content"><div id="day'+h+k+'" data-orderid="'+d+'" class="tab-pane active"><div class="basket-head"><div class="weight">Вес: <span></span> кг.</div><div class="amount">Итого: <span></span> руб.</div></div><ul class="catalog-order"></ul><div class="basket-bottom"><a class="refresh">Обновить</a><a href="#" class="btn btn-sm btn-primary no-border btn-order">Оформить</a><a href="#" class="btn btn-sm btn-cancel no-border">Отменить</a></div></div></div></div>';a(".shop-right").append(m)}else{var o=a(".tabs-days");a(".tabs-days .active").removeClass("active"),m='<li class="active"><a data-toggle="tab" data-date="'+c+'" href="#day'+d+'">'+i+"<span>"+h+"."+k+"</span></a></li>",o.find(".nav-tabs").append(m),m='<div id="day'+d+'" data-orderid="'+d+'" class="tab-pane active"><div class="basket-head"><div class="amount">Итого: <span></span></div></div><ul class="catalog-order"></ul><div class="basket-bottom"><a class="refresh">Обновить</a><a href="#" class="btn btn-sm btn-primary no-border btn-order">Оформить</a><a href="#" class="btn btn-sm btn-cancel no-border">Отменить</a></div></div>',o.find(".tab-content").append(m)}a(".nav-tabs a").click(function(){var b=a(this).closest(".tabs-days").find(".tab-pane.active").attr("data-orderid"),c={};c.text=a(this).find("span").text(),c.date=a(this).attr("data-date"),j(!1,b,c,null,null,e)});var p=require("shop-spinner");p.initRefresh();var q=a(".tabs-days .tab-pane.active");q.find(".btn-cancel").on(ace.click_event,function(c,d){c.preventDefault(),bootbox.confirm("Вы действительно хотите отменить заказ ?",function(c){if(c){var e=a(".tab-pane.active").data("orderid");g(),b.client.cancelOrder(e),d&&b.client.deleteOrder(e)}}),a(".modal-backdrop").click(function(){a(".modal.in .close").trigger("click"),a(this).hide()})}),q.find(".btn-order").click(function(c){c.preventDefault();var d=a(".tab-pane.active");d.find(".refresh").trigger("click"),e||(e=b.client.getOrderDetails(d.attr("data-orderid")));var f=require("shop-common"),g=f.countAmount(d.find(".catalog-order"),e),j=a(".weight span").text(),l=d.find(".catalog-order").html(),m=[],o=[],p=0;d.find(".catalog-order td .spinner1").each(function(){m[p]=a(this).closest(".ace-spinner").spinner("value"),o[p++]=a(this).data("step")}),a(".page").hide();var q={orderDay:h,orderMonth:k,orderWeekDay:i};n(l,g,m,q,j,e)})}function n(d,e,f,g,i,k){a(".shop-confirm").load("../ajax/ajax-confirmOrder.html .dynamic",function(){a("footer").removeClass("short-footer");var l=document.location.hash;if("#confirm-order"!=l){var m,n={type:"page",pageName:"confirm-order"};m=-1==l.indexOf("#")?l:"",window.history.pushState(n,null,m+"#"+n.pageName)}var p,q,r=a(".tab-pane.active").data("orderid");q=k?k:b.client.getOrderDetails(r);var s=a(".delivery-right .radio");s.find("input").prop("checked",!1);var t=a(".shop.dynamic").attr("id"),v=b.client.getShop(t),z=v.address;switch(q.delivery){case 1:s.find('input:not(".courier-delivery")').prop("checked",!0),u(z);break;default:s.find("input.courier-delivery").prop("checked",!0),u(q.deliveryTo);var B=b.client.getUserDeliveryAddresses().elems;A=q.deliveryTo,w(r,B)}var C=a(".confirm-order .catalog-confirm");C.html(d),y(r,q),x(z);var D=a(".tabs-days .nav-tabs li.active a").html(),E=D.split("<span>")[0];p="string"==typeof g?g:a(".tabs-days .nav-tabs li.active a span").text()+" ("+E+")",a(".order-date span").text(p),a(".itogo-right span").text(e),a(".weight-right span").text(i),C.find(".modal-body").remove();var F=0,G=b.userClient.getUserContacts();G.mobilePhone&&a("#phone-delivery").val(G.mobilePhone),C.find("td .ace-spinner").each(function(){var b=a(this).find(".spinner1").data("step");a(this).after('<input type="text" data-step="'+b+'" class="input-mini spinner1 spinner-input form-control no-init" maxlength="3">'),c.InitSpinner(a(this).find("+.spinner1"),f[F++],1,b),a(this).find(".spinner1").attr("disabled")&&a(this).find("+.ace-spinner").spinner("disable"),a(this).remove()}),h(C.find(".delete-product"),q);var H=require("shop-common");H.InitProductDetailPopup(C.find(".product-link")),c.initRefresh();var I={orderId:r,userContacts:G,shop:v};o(a(".confirm-order .btn-order"),I),a(".confirm-order .btn-cancel").click(function(){a(".page.shop-confirm").hide(),window.history.back()}),a(".order-date").click(function(b){b.preventDefault();var c=a(".tab-pane.active").attr("data-orderid"),d={};d.text=a(this).find("span").text(),d.text=d.text.split(" ")[0],d.date=a(".tabs-days .nav-tabs a.active").attr("data-date"),j(!1,c,d,null,null,q)})}).show()}function o(c,d){c.click(function(){var c=a("#phone-delivery"),e=a(".alert-delivery-phone"),h=d.orderId,i=d.shop,j=a(".delivery-address").find(".error-info").length>0;if(c.val()){var k=0;try{d.userContacts.mobilePhone!=c.val()&&(d.userContacts.mobilePhone=c.val(),b.userClient.updateUserContacts(d.userContacts))}catch(m){k=1,e.text("Телефон должен быть вида 79219876543, +7(821)1234567 и т.п").show()}var n;j&&(n=b.client.setOrderDeliveryType(h,1),u(i.address)),k||(e.hide(),g(),a(".shop-orderEnd").load("../ajax/ajax-orderEnd.html .dynamic",function(){var c=document.location.href;c=c.split("#")[0],a(".to-main-link").attr("href",c),a(".page").hide(),a(this).show();var d=b.client.getOrder(h);n=n?n:b.client.getOrderDetails(h);var e=a(".itogo-right span").text();a(".bill-amount span,.all-amount span").text(e),a(".bill-delivery-address span").text(a(".input-delivery .delivery-address").text()),a(".bill-date-delivery span").text(a(".order-date span").text()),a(".bill-client span").text(a(".user-info").text()),a(".bill-client-phone span").text(a("#phone-delivery").val()),a(".bill-pay-type span").text(p(n.paymentType)),a(".bill-weight span").text(a(".weight-right span").text()+" кг.");var g=new Date(1e3*n.createdAt),j=g.getDate(),k=g.getDay(),m=g.getMonth()+1;j=10>j?"0"+j:j,m=10>m?"0"+m:m,k=l(k),a(".bill-shop-name span").text(i.name),a(".bill-order-number span").text(d.id),a(".bill-date-order span").text(j+"."+m+" ("+k+")"),a(".bill-shop-phone span").text("---"),a(".bill-shop-email span").text("---"),a(".order-end-logo img").attr("src",i.logoURL);var o=a(".delivery-cost").text(),q=e-o,r=a(".bill-delivery span");r.text("0"!=o?o+" р.":"---"),a(".bill-amount-order span").text(q.toFixed(1));var s="",t=a("#order-comment");if(t.val()){var u="<div class='bill-comment'><h4>Комментарий: </h4><div>"+t.val()+"</div></div>";a(".bill-delivery").after(u),s=t.val()}b.client.confirmOrder(h,s);var v=!0;a(".bill-order-list").append(f.createOrdersProductHtml(n,v))}))}else e.text("Пожалуйста введите номер телефона.").show(),a("#phone-delivery").focus()})}function p(a){var b;switch(a){case 0:b="Неизвестно";break;case 1:b="Наличными";break;case 2:b="Кредитной карточкой";break;case 3:b="Трансфер";break;case 4:b="Кредит"}return b}function q(c,d){var e=0,f=a(".tab-pane.active"),g=f.data("orderid"),h=require("shop-common");a(".catalog-order li").each(function(){a(this).data("productid")==c.id&&(e=1)});var i;if(e){var j=a('.catalog-order li[data-productid="'+c.id+'"]'),k=j.find(".td-spinner .ace-spinner"),l=c.qnty;k.spinner("value",parseFloat(l).toFixed(1));k.spinner(h.getPacksLength(d)<=1?"enable":"disable"),i=b.client.setOrderLine(g,c.id,l,"",d),f.find(".weight span").text(h.getOrderWeight(g,i));var m=(l*parseFloat(j.find(".td-price").text())).toFixed(1);j.find(".td-summa").text(m),f.find(".amount span").text(h.countAmount(f.find(".catalog-order"),i))}else i=b.client.setOrderLine(g,c.id,c.qnty,"",d),r(c,c.qnty,0,i),f.find(".weight span").text(h.getOrderWeight(g,i));(c.packVal>1||0!=c.prepackLine.length||d&&h.getPacksLength(d)>1)&&(k=a('.catalog-order li[data-productid="'+c.id+'"]').find(".td-spinner .ace-spinner"),k.spinner("disable"))}function r(b,d,e,f){var g,i=require("shop-common");g=b.imageURL?b.imageURL:i.noPhotoPic;var j='<li class="product" data-productid="'+b.id+'" data-prepack="'+b.prepackRequired+'"><table><tr><td class="td-price product-price">'+b.price+'</td><td class="td-spinner"><input type="text" data-step="'+b.minClientPack+'" class="input-mini spinner1 no-init" /><span class="unit-name">'+b.unitName+'</span></td><td class="td-summa">'+(b.price*d).toFixed(1)+'</td><td class="td-producer" data-producerid="'+b.producerId+'">'+b.producerName+'</td><td class="td-close"><a href="#" class="delete-product no-init">×</a></td></tr></table><a href="#" class="product-link no-init"><span><img src="'+g+'" alt="'+b.name+'"/></span><div class="product-right-descr product-name">'+b.name+'</div></a><div class="modal"></div></li>',k=a(".tab-pane.active"),l=k.find(".catalog-order");l.append(j),k.find(".amount span").text(i.countAmount(l,f));var m=k.find(".catalog-order .delete-product.no-init");h(m,f),m.removeClass("no-init");var n=k.find(".catalog-order .product-link.no-init");i.InitProductDetailPopup(n),n.removeClass("no-init");var o=k.find(".catalog-order .spinner1.no-init"),p=1;c.InitSpinner(o,parseFloat(d).toFixed(1),p,b.minClientPack),e&&o.closest(".ace-spinner").spinner("disable"),o.removeClass("no-init")}function s(a){a.trigger("click")}function t(){var a=parseInt(new Date/1e3);a-=a%86400;var c=b.client.getNextOrderDate(a);return c.orderDate}function u(b){a(".input-delivery .delivery-address").text(b.country.name+", "+b.city.name+", "+b.street.name+" "+b.building.fullNo+", кв. "+b.flatNo)}function v(c,d,e){for(var f,g=d?d:b.client.getUserDeliveryAddresses().elems,h="",i=g.length,j=0;i>j;j++)f=b.client.getUserDeliveryAddress(g[j]),h+='<li><a data-addresstext="'+g[j]+'" href="#">'+f.street.name+" "+f.building.fullNo+", кв. "+f.flatNo+"</a></li>";h+='<li class="divider"></li><li><a href="#" class="delivery-add-address">Добавить адрес ...</a></li>',a(".delivery-dropdown .dropdown-menu").html("").prepend(h),a('.delivery-dropdown .dropdown-menu a:not(".delivery-add-address")').click(function(d){d.preventDefault();var e=a(this).parent().index();A=b.client.getUserDeliveryAddress(g[e]),u(A);var f=a(this).data("addresstext"),h=b.client.getDeliveryAddressViewURL(f,F,G);a(".address-map").remove(),a(this).closest(".input-delivery").find(".address-input").after("<img class='address-map' src='"+h+"'>");var i=b.client.setOrderDeliveryType(c,2,A);y(c,i)}),a(".delivery-add-address").click(function(b){b.preventDefault(),a(".address-input .street-delivery").val(""),a(".address-input .building-delivery").val(""),a(".address-input .flat-delivery").val(""),a(".address-input").show(),a(".delivery-dropdown .btn-group-text").text("Выбрать адрес")}),e||a(".add-address").click(function(d){d.preventDefault();var e=a(".street-delivery").val(),f=a(".building-delivery").val(),g=a(".flat-delivery").val();if(a(".country-delivery").val()&&a(".city-delivery").val()&&e&&f&&g){var h=e+" "+f,i=A=b.client.createDeliveryAddress(h,parseInt(g),0,0,0),j=b.client.getDeliveryAddressViewURL(h,F,G);a(".address-map").remove(),a(this).closest(".address-input").after("<img class='address-map' src='"+j+"'>"),a(".alert-delivery-addr").hide();var k=a(".address-input");k.slideUp();var l=require("shop-common");l.addAddressToBase(k,i),u(i);var m=b.client.setOrderDeliveryType(c,2,i);y(c,m);var n=!0;v(c,0,n)}else a(".alert-delivery-phone").hide(),a(".alert-delivery-addr").text("Введите полный адрес доставки !").show()})}function w(b,c){a(".delivery-dropdown").show(),v(b,c)}function x(c){a(".radio input").click(function(){var d,e=a(".itogo-right span"),f=a(".tab-pane.active").data("orderid"),g=require("shop-common"),h=b.client.getUserDeliveryAddresses().elems;if(a(this).hasClass("courier-delivery")){var i=b.userClient.getUserContacts().homeAddress;h.length||(A=null),A||(i?A=i:h.length&&(A=b.client.getUserDeliveryAddress(h[0])));var j=A;if(w(f,h),j?(u(j),d=b.client.setOrderDeliveryType(f,2,j),y(f,d)):(a(".input-delivery .delivery-address").html("<span class='error-info'>Введите пожалуйста адрес доставки.</span>"),a(".input-delivery .delivery-address .error-info").show(),a(".delivery-add-address").trigger("click")),e.text(g.countAmount(a(".confirm-order"),d)),E=1,D){var k=require("shop-search");k.initAutocompleteAddress(a(".address-input")),D=0}a(".address-map").slideDown(200)}else d=b.client.setOrderDeliveryType(f,1),a(".address-map").slideUp(200),u(c),y(f,d),a(".delivery-dropdown").hide(),E&&(e.text(g.countAmount(a(".confirm-order")),d),E=0)})}function y(c,d,e){var f=d?d:b.client.getOrderDetails(c);a(".delivery-cost").text(f.deliveryCost?f.deliveryCost:"0");var g=require("shop-common"),h=e?e:a(".catalog-confirm");a(".itogo-right span,.amount span").text(g.countAmount(h,d))}bootbox.setDefaults({locale:"ru"});var z,A,B=0,C=a.Callbacks(),D=1,E=0,F=400,G=300;return{cleanBasket:g,InitDeleteProduct:h,flagFromBasketClick:B,AddProductToBasketCommon:q,InitAddToBasket:i,BasketTrigger:s,AddSingleProductToBasket:r,addTabToBasketHtml:m,setDeliveryCost:y,GoToConfirm:n,initChooseDatepicker:j,getWeekDay:l,getNextDate:t,callbacks:C,selectorForCallbacks:z}});