define("import",["jquery","shop-initThrift","bo-common"],function(a,b,c){function d(){function d(a,b,c,d){for(var e="",f=a.length,g=c.length,h="",i=!1,j=0;g>j;j++)i||(h+='<li data-fieldtype="'+d[j]+'"><a href="#">'+c[j]+"</a></li>"),c[j]==l&&(i=!0);for(i||(h+='<li data-fieldtype="-1"><a href="#">'+l+"</a></li>"),j=0;f>j;j++)e+='<td><div class="btn-group import-field-dropdown"><button data-toggle="dropdown" data-fieldtype="'+b[j]+'" class="btn btn-info btn-sm dropdown-toggle no-border"><span class="btn-group-text">'+a[j]+'</span><span class="icon-caret-down icon-on-right"></span></button><ul class="dropdown-menu dropdown-blue">'+h+"</ul></div></td>";return e}function e(a,b){function c(a,b){for(var c,d="",e="",f=0;b>f;f++)e=a[f],e&&e.length>30&&(c=e,e=e.slice(0,30),e+=" <a class='show-full-text' href='#'>...</a>"+'<div class="full-text"><a href="#" class="close">×</a>'+c+"</div>"),d+="<td>"+e+"</td>";return d}for(var d="",e=a.length,f=0;e>f;f++)d+="<tr>"+c(a[f],b)+"</tr>";return d}var f=parseInt((new Date).getTime()/1e3);f-=f%86400;var g,h,i,j,k=[];a(".form-import").submit(function(f){f.preventDefault();var m=a("#import-data").val();if("Тип импортируемых данных"==a(".import-dropdown .btn-group-text").text())a(".import").find(".error-info").text("Пожалуйста, укажите тип импортируемых данных.").show();else if(m){{a("#import-public").val()}m=m.split("\\");var n=m.length,o=(m[n-1],new FormData),p=a(".form-import #import-data");o.append("data",p[0].files[0]),a.ajax({type:"POST",url:"/file/",cache:!1,processData:!1,contentType:!1,data:o,success:function(f){j=f;var m=b.clientBO.parseCSVfile(j);g=m.elems,h=m.rowCount;var n=g.length;i=n/h;var o=0;k=[];for(var p=0;h>p;p++){k[p]=[];for(var q=0;i>q;q++)k[p][q]=g[o++]}var r=a(".import-dropdown .btn-group-text").text(),s=[],t=[],u=com.vmesteonline.be.shop.bo.ExchangeFieldType;switch(o=0,r){case"Продукты":for(var v in u)u[v]>=300&&u[v]<330&&(s[o]=v,t[o++]=u[v]);break;case"Категории продуктов":for(v in u)u[v]>=200&&u[v]<230&&(s[o]=v,t[o++]=u[v]);break;case"Производители":for(v in u)u[v]>=100&&u[v]<130&&(s[o]=v,t[o++]=u[v])}var w,x,y=s.slice(0),z=t.slice(0);if(o>i)for(w=o,x=i,p=w-1;p>=x;p--)s.pop(),t.pop();if(i>o)for(w=i,x=o,p=w-1;p>=x;p--)s[p]=l,t[p]=-1;var A="<table><thead><tr>"+d(s,t,y,z)+"</tr></thead><tbody>"+e(k,s.length)+"</tbody></table>";a(".import-table").html("").prepend(A).parent().show(),a(".top-scroll").remove(),c.DoubleScroll(document.getElementById("doublescroll")),c.initShowFullText(),c.initCloseFullText(),a(".import-field-dropdown .dropdown-toggle").click(function(b){b.preventDefault();var c=a(this).closest("td").index(),d=0,e=0;a(".import-table table").find("td").each(function(){c>e&&(d+=a(this).width()),e++}),d-=a(".import-table").scrollLeft();var f=94;a(this).parent().find(".dropdown-menu").css({left:d,top:f})}),a(".import-field-dropdown .dropdown-menu").find("li a").click(function(b){b.preventDefault();var c=a(this).parent().text(),d=a(this).parent().data("fieldtype");a(".import-field-dropdown").each(function(){a(this).find(".btn-group-text").text()==c&&(a(this).find(".dropdown-toggle").attr("data-fieldtype",-1),a(this).find(".btn-group-text").text(l))});var e=a(this).closest(".import-field-dropdown");e.find(".btn-group-text").text(c).parent().data("fieldtype",d)}),c.setSidebarHeight(a(".main-content").height())}})}else a(".import").find(".error-info").text("Пожалуйста, выберите файл.").show()}),a("#import-data").click(function(){a(".import").find(".error-info").hide()}),a(".checkbox .lbl").click(function(){a(this).closest(".checkbox").toggleClass("active")}),a(".import-dropdown .dropdown-menu li").click(function(){a(".import").find(".error-info").hide()});var l="SKIP";a(".import-btn").click(function(c){function d(){a(".confirm-info").hide()}c.preventDefault();var e=a(".import-field-dropdown"),g=e.length,h="",i=!1;e.each(function(){if(!i)for(var b=a(this).parent().index(),c=a(this).find(".btn-group-text").text(),d=b+1;g>d;d++)if(c==e.eq(d).find(".btn-group-text").text()&&c!=l){h=c,i=!0;break}});var k=a(this).closest(".back-tab").find(".confirm-info");if(i)k.text("Вы указали два столбца с одинаковым занчением : "+h).show();else{k.hide();var m,n=a(".import-dropdown .btn-group-text").text();switch(n){case"Продукты":m=com.vmesteonline.be.shop.bo.ImExType.IMPORT_PRODUCTS;break;case"Категории продуктов":m=com.vmesteonline.be.shop.bo.ImExType.IMPORT_CATEGORIES;break;case"Производители":m=com.vmesteonline.be.shop.bo.ImExType.IMPORT_PRODUCERS}var o=[],p=0;a(".import .import-field-dropdown").each(function(){var b=a(this).find(".btn-group-text").text();b!=l&&(o[p]=parseInt(a(this).find(".btn").data("fieldtype"))),p++});var q=new com.vmesteonline.be.shop.bo.ImportElement;q.type=m,q.filename="filename",q.fieldsMap=o,q.url=j;var r=[];r[0]=q;var s=new com.vmesteonline.be.shop.bo.DataSet;s.name="name",s.date=f,s.data=r,a(".loading").fadeIn(function(){try{b.clientBO.importData(s),k.text("Данные успешно импортированы.").addClass("info-good").show()}catch(c){k.text("Ошибка импорта.").show()}a(".loading").fadeOut(0),setTimeout(d,3e3)})}})}return{initImport:d}});