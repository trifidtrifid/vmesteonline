require.config({baseUrl:"/build",paths:{jquery:"../js/lib/jquery-2.1.1.min",bootstrap:"../js/lib/bootstrap.min",ace_extra:"../js/lib/ace-extra.min",ace_elements:"../js/lib/ace-elements.min",jquery_ui:"../js/lib/jquery-ui-1.10.3.full.min",flexslider:"../js/lib/jquery.flexslider-min",ace_spinner:"../js/lib/fuelux/fuelux.spinner","datepicker-backoffice":"../js/bootstrap-datepicker-backoffice","datepicker-ru":"../js/lib/date-time/locales/bootstrap-datepicker.ru",multiselect:"../js/lib/jquery.multiselect.min"},shim:{ace_spinner:{deps:["jquery","ace_extra","ace_elements","jquery_ui"],exports:"ace_spinner"},jquery_ui:{deps:["jquery"],exports:"jquery_ui"},bootstrap:{deps:["jquery"],exports:"bootstrap"},"datepicker-backoffice":{deps:["jquery","jquery_ui"],exports:"datepicker-backoffice"},"datepicker-ru":{deps:["jquery","datepicker-backoffice"],exports:"datepicker-ru"},flexslider:{deps:["jquery"],exports:"flexslider"},multiselect:{deps:["jquery","jquery_ui"],exports:"multiselect"}}});var deliveryFilterFlag=0,statusFilterFlag=0,dateFilterFlag=0,searchFilterFlag=0,orders;require(["jquery","shop-initThrift.min","commonM.min","shop-orders.min","datepicker-backoffice","datepicker-ru","bootstrap","multiselect"],function(a,b,c,d){function e(){try{orders=b.client.getOrdersByStatus(0,C+180*D,0),a(".orders-list").html("").append(h(orders));var c=a(".orders-no-init");f(c),c.removeClass("orders-no-init"),deliveryFilterFlag=0,statusFilterFlag=0,dateFilterFlag=0,searchFilterFlag=0}catch(d){}}function f(c){c.find(".plus-minus").click(function(c){c.preventDefault();var e=a(this).closest(".order-item"),f=e.find(".order-products");if(0==f.find(".catalog").length){var h=e.data("orderid"),i=b.client.getOrderDetails(h);d.showOrderDetails(e,h,i),f.append(g(i))}f.slideToggle(200,function(){a(".main-content").height()>B.height()&&a("#sidebar, .shop-right").css("height",a(".main-content").height()+45)}),a(this).hasClass("fa-plus")?a(this).removeClass("fa-plus").addClass("fa-minus"):a(this).removeClass("fa-minus").addClass("fa-plus")})}function g(a){try{var c='<section class="catalog"><table><thead><tr><td>Название</td><td>Производитель</td><td>Цена (руб)</td><td>Количество</td><td>Стоимость</td><td>Ед.изм</td><td></td></tr></thead>',d=a.odrerLines,e=d.length;E=E?E:b.client.getProducers(),F=F?F:E.length;for(var f=0;e>f;f++){for(var g,h,i="",j=0;F>j;j++)if(E[j].id==d[f].product.producerId){g=E[j].name,h=E[j].id;break}d[f].product.unitName&&(i=d[f].product.unitName);var k;k=d[f].product.imageURL?d[f].product.imageURL:"i/no-photo.png",c+='<tr class="product" data-prepack="'+d[f].product.prepackRequired+'" data-productid="'+d[f].product.id+'"><td><a href="#" class="product-link"><div class="product-pic"><img src="'+k+'" alt="картинка"/></div><span><span class="product-name">'+d[f].product.name+"</span>"+d[f].product.shortDescr+'</span></a><div class="modal"></div></td><td class="td-producer" data-producerid="'+h+'">'+g+'</td><td class="product-price">'+d[f].product.price+'</td><td class="td-spinner">'+d[f].quantity+'</td><td class="orderLine-amount"><span>'+(d[f].product.price*d[f].quantity).toFixed(1)+'</span></td><td><span class="unit-name">'+i+"</span></td></tr>"}c+="</table></section>"}catch(l){alert(l+" Функция createOrdersProductHtml")}return c}function h(a,b){try{var c="",d=a.length,e=0,f=100;b&&(f=lengthOrders,d-=offsetOrders),d>f&&(e=d-f);for(var g=d-1;g>=e;g--){var h,i=new Date(1e3*a[g].date);switch(a[g].status){case 0:h="Неизвестен";break;case 1:h="Не подтвержден";break;case 2:h="Подтвержден";break;case 3:h="Уже едет";break;case 4:h="Доставлен";break;case 5:h="Закрыт";break;case 6:h="Отменен"}var j=i.getDate();j=10>j?"0"+j:j;var k=i.getMonth()+1;k=10>k?"0"+k:k,c+='<div class="order-item orders-no-init" data-orderid="'+a[g].id+'"><table class="orders-tbl"><tbody><tr><td class="td1"><a class="fa fa-plus plus-minus" href="#"></a></td><td class="td2">'+a[g].id+'</td><td class="td8 user-name">'+a[g].userName+'</td><td class="td3" id="'+a[g].date+'">'+j+"."+k+"."+i.getFullYear()+'</td><td class="td4"><div class="order-status">'+h+'</div></td><td class="td9"></td><td class="td8"></td><td class="td6">'+a[g].totalCost.toFixed(1)+'</td></tr></tbody></table><div class="order-bottom"><div class="order-delivery"></div></div><div class="order-products"></div></div>'}}catch(l){alert(l+" Функция createOrdersHtml")}return c}function i(a){var b;switch(a){case"Подтвержден":b=2;break;case"Не подтвержден":b=1;break;case"Отменен":b=6}return b}function j(a){var b;switch(a){case"Самовывоз":b="1";break;case"Курьер рядом":b="2";break;case"Курьер далеко":b="3"}return b}function k(c){for(var d=[],e=0,f=c.length,g=a(".type-delivery-dropdown .btn-group-text").text(),h=j(g),i=0;f>i;i++){var k=b.client.getOrderDetails(c[i].id);h==k.delivery&&(d[e++]=c[i])}return d}function l(){try{var a=G.val().split("-"),b="",c=a[2];switch(a[1]){case"01":b="Jan";break;case"02":b="Feb";break;case"03":b="March";break;case"04":b="Apr";break;case"05":b="May";break;case"06":b="June";break;case"07":b="July";break;case"08":b="Aug";break;case"09":b="Sen";break;case"10":b="Oct";break;case"11":b="Nov";break;case"12":b="Dec"}}catch(d){alert(d+" Функция getMetaDate")}return Date.parse(a[0]+" "+b+" "+c)}function m(a){var b=parseInt(l()/1e3);b-=b%86400,b+=D;for(var c=a.length,d=[],e=0,f=0;c>f;f++)a[f].date==b&&(d[e++]=a[f]);return d}function n(){var b=a(".orders-no-init");f(b),b.removeClass("orders-no-init")}function o(b){var c=0,d=[],e=b.length,f=a(".status-dropdown .btn-group-text").text(),g=i(f);for(P=0;e>P;P++)g==b[P].status&&(d[c++]=b[P]);return d}function p(a){var c=b.client.getOrdersByStatus(0,C+180*D,0),d=q(c,a);return statusFilterFlag&&(d=o(d)),deliveryFilterFlag&&(d=k(d)),dateFilterFlag&&(d=m(d)),searchFilterFlag=1,d}function q(a,b){var c=a.length,d=[];L=0;for(var e=0;c>e;e++)-1!=a[e].userName.toLowerCase().indexOf(b.toLowerCase())&&(d[L++]=a[e]);return d}function r(){a(".show-full-text").click(function(b){if(b.preventDefault(),a(this).closest(".export-table").length>0)var c=b.pageX-330,d=b.pageY-90;else c=b.pageX-200,d=b.pageY-200;a(".full-text").hide(),a(this).parent().find(".full-text").css({left:c,top:d}).show()})}function s(){a(".full-text .close").click(function(b){b.preventDefault(),a(this).parent().hide()})}function t(a,b,c,d){for(var e="",f=a.length,g=c.length,h="",i=!1,j=0;g>j;j++)i||(h+='<li data-fieldtype="'+d[j]+'"><a href="#">'+c[j]+"</a></li>"),c[j]==W&&(i=!0);for(i||(h+='<li data-fieldtype="-1"><a href="#">'+W+"</a></li>"),j=0;f>j;j++)e+='<td><div class="btn-group import-field-dropdown"><button data-toggle="dropdown" data-fieldtype="'+b[j]+'" class="btn btn-info btn-sm dropdown-toggle no-border"><span class="btn-group-text">'+a[j]+'</span><span class="icon-caret-down icon-on-right"></span></button><ul class="dropdown-menu dropdown-blue">'+h+"</ul></div></td>";return e}function u(a,b){function c(a,b){for(var c,d="",e="",f=0;b>f;f++)e=a[f],e&&e.length>30&&(c=e,e=e.slice(0,30),e+=" <a class='show-full-text' href='#'>...</a>"+'<div class="full-text"><a href="#" class="close">×</a>'+c+"</div>"),d+="<td>"+e+"</td>";return d}for(var d="",e=a.length,f=0;e>f;f++)d+="<tr>"+c(a[f],b)+"</tr>";return d}function v(b){var c,d=[],e=0,f=[];L=0;var g=[],h=a(".ui-multiselect-menu:eq(0) .ui-multiselect-checkboxes li");switch(h.each(function(){a(this).hasClass("ui-multiselect-optgroup-label")&&(g[L++]=a(this).index())}),b){case"orders":var i=h.slice(g[0]+1,g[1]);c=i.find('input[aria-selected="true"]');break;case"orderLine":i=h.slice(g[1]+1),c=i.find('input[aria-selected="true"]');break;case"products":var j=a(".ui-multiselect-menu:eq(1) .ui-multiselect-checkboxes li");c=j.find('input[aria-selected="true"]');break;case"packs":var k=a(".ui-multiselect-menu:eq(2) .ui-multiselect-checkboxes li");c=k.find('input[aria-selected="true"]')}return L=0,c.each(function(){d[e++]=parseInt(a(this).val()),f[L++]=a(this).find("+span").text()}),{fieldsMap:d,headColArray:f}}function w(b,c,d,e){var f=a(".tab-pane.active").find(".export-table");f.html("");for(var g=[],h=c-1;h>=0;h--){g=[];for(var i=b.data[h].fieldsData,j=i.rowCount,k=Math.ceil(i.elems.length/j),l=0,m=0;j>m;m++){g[m]=[];for(var n=0;k>n;n++)g[m][n]=i.elems[l++]}var o,p=0;b.data[h].fieldsMap?(o=d.headColArray,e&&(o=h==c-1?d.headColArray:e.headColArray)):(o=g[0],p=1);var q='<div class="export-single-table"><table><thead><tr>'+x(o)+"</tr></thead><tbody>"+y(g,k,p)+"</tbody></table></div>";q+='<div class="report-link"><a href="'+b.data[h].url+'">Скачать отчет</a>',f.append(q)}}function x(a){var b="",c=a.length;for(P=0;c>P;P++)b+="<td>"+a[P]+"</td>";return b}function y(a,b,c){function d(a,b){for(var c,d="",e="",f=0;b>f;f++)e=a[f],e&&e.length>30&&(c=e,e=e.slice(0,30),e+=" <a class='show-full-text' href='#'>...</a>"+'<div class="full-text"><a href="#" class="close">×</a>'+c+"</div>"),d+="<td>"+e+"</td>";return d}for(var e="",f=a.length,g=c;f>g;g++)e+="<tr>"+d(a[g],b)+"</tr>";return e}function z(b){try{var c=a(".main-content"),d=b?b:c.height();d>B.height()?(d=b?b+100:c.height()+45,a("#sidebar").css("height",d)):a("#sidebar").css("height","100%")}catch(e){alert(e+" Функция setSidebarHeight")}}function A(b){var c=document.createElement("div");c.appendChild(document.createElement("div")),c.style.overflow="auto",c.style.overflowY="hidden",c.firstChild.style.width=b.scrollWidth+"px",c.firstChild.style.paddingTop="1px",c.firstChild.style.marginTop="-5px",c.firstChild.appendChild(document.createTextNode(" ")),c.onscroll=function(){b.scrollLeft=c.scrollLeft},b.onscroll=function(){c.scrollLeft=b.scrollLeft},b.parentNode.insertBefore(c,b),a(b).prev().addClass("top-scroll")}c.init();var B=a(window),C=parseInt((new Date).getTime()/1e3);C-=C%86400;var D=86400;e();var E,F;try{var G=a("#date-picker-1"),H=a(".datepicker-export");globalUserAuth=!0,G.datepicker({autoclose:!0,language:"ru"}).next().on(ace.click_event,function(){a(this).prev().focus()}),console.log("---------------------"),H.datepicker({autoclose:!0,language:"ru"}).next().on(ace.click_event,function(){a(this).prev().focus()});var I={createOrdersHtml:h,initOrderPlusMinus:f,setSidebarHeight:z,filterByStatus:o,filterByDelivery:k,filterBySearch:q};G.datepicker("setVarOrderDates",I),H.datepicker("setVarOrderDates",I),a(".reset-filters").click(function(){e(),a(".type-delivery-dropdown .btn-group-text").text("Тип доставки"),a(".status-dropdown .btn-group-text").text("Статус заказа"),a("#back-search").val("Поиск по имени клиента или номеру телефона"),G.val("Фильтр по дате")})}catch(J){}a("#date-picker-2,#date-picker-3,#date-picker-4").val("Фильтр по дате"),a(".export .checkbox input.ace").prop("checked",!1),a(".status-dropdown .dropdown-menu li").click(function(c){c.preventDefault();var d=a(this).find("a").text(),e=i(d),f=b.client.getOrdersByStatus(0,C+180*D,e);deliveryFilterFlag&&(f=k(f)),searchFilterFlag&&(f=q(f,a("#back-search").val())),dateFilterFlag&&(f=m(f)),a(".orders-list").html("").append(h(f)),n(),statusFilterFlag=1}),a(".type-delivery-dropdown .dropdown-menu li").click(function(c){c.preventDefault();var d=b.client.getOrdersByStatus(0,C+180*D,0),e=k(d);statusFilterFlag&&(e=o(e)),searchFilterFlag&&(e=q(e,a("#back-search").val())),dateFilterFlag&&(e=m(e)),a(".orders-list").html("").append(h(e)),n(),deliveryFilterFlag=1});var K=[],L=0;a(".back-orders .order-item").each(function(){K[L++]=a(this).find(".user-name").text()});var M=K.length,N=[],O=0;L=0;for(var P=0;M-1>P;P++){O=0;for(var Q=P+1;M>Q;Q++)K[P]==K[Q]&&(O=1);O||(N[L++]=K[P])}N[L]=K[M-1],a("#back-search").focus(function(){a(this).autocomplete({source:N,select:function(b,c){a(".orders-list").html("").append(h(p(c.item.label))),n()}})}),a(".search-form").submit(function(b){b.preventDefault();var c=a("#back-search").val();a(".orders-list").html("").append(h(p(c))),n()});var R,S,T,U,V=[];a(".form-import").submit(function(c){c.preventDefault();var d=a("#import-data").val();if("Тип импортируемых данных"==a(".import-dropdown .btn-group-text").text())a(".import").find(".error-info").text("Пожалуйста, укажите тип импортируемых данных.").show();else if(d){{a("#import-public").val()}d=d.split("\\");var e=d.length,f=(d[e-1],new FormData),g=a(".form-import #import-data");f.append("data",g[0].files[0]),a.ajax({type:"POST",url:"/file/",cache:!1,processData:!1,contentType:!1,data:f,success:function(c){U=c;var d=b.clientBO.parseCSVfile(U);R=d.elems,S=d.rowCount;var e=R.length;T=e/S;var f=0;V=[];for(var g=0;S>g;g++){V[g]=[];for(var h=0;T>h;h++)V[g][h]=R[f++]}var i=a(".import-dropdown .btn-group-text").text(),j=[],k=[],l=com.vmesteonline.be.shop.bo.ExchangeFieldType;switch(f=0,i){case"Продукты":for(var m in l)l[m]>=300&&l[m]<330&&(j[f]=m,k[f++]=l[m]);break;case"Категории продуктов":for(m in l)l[m]>=200&&l[m]<230&&(j[f]=m,k[f++]=l[m]);break;case"Производители":for(m in l)l[m]>=100&&l[m]<130&&(j[f]=m,k[f++]=l[m])}var n,o,p=j.slice(0),q=k.slice(0);if(f>T)for(n=f,o=T,g=n-1;g>=o;g--)j.pop(),k.pop();if(T>f)for(n=T,o=f,g=n-1;g>=o;g--)j[g]=W,k[g]=-1;var v="<table><thead><tr>"+t(j,k,p,q)+"</tr></thead><tbody>"+u(V,j.length)+"</tbody></table>";a(".import-table").html("").prepend(v).parent().show(),a(".top-scroll").remove(),A(document.getElementById("doublescroll")),r(),s(),a(".import-field-dropdown .dropdown-toggle").click(function(b){b.preventDefault();var c=a(this).closest("td").index(),d=0,e=0;a(".import-table table").find("td").each(function(){c>e&&(d+=a(this).width()),e++}),d-=a(".import-table").scrollLeft();var f=94;a(this).parent().find(".dropdown-menu").css({left:d,top:f})}),a(".import-field-dropdown .dropdown-menu").find("li a").click(function(b){b.preventDefault();var c=a(this).parent().text(),d=a(this).parent().data("fieldtype");a(".import-field-dropdown").each(function(){a(this).find(".btn-group-text").text()==c&&(a(this).find(".dropdown-toggle").attr("data-fieldtype",-1),a(this).find(".btn-group-text").text(W))});var e=a(this).closest(".import-field-dropdown");e.find(".btn-group-text").text(c).parent().data("fieldtype",d)})}})}else a(".import").find(".error-info").text("Пожалуйста, выберите файл.").show()}),a("#import-data").click(function(){a(".import").find(".error-info").hide()}),a(".checkbox .lbl").click(function(){a(this).closest(".checkbox").toggleClass("active")}),a(".import-dropdown .dropdown-menu li").click(function(){a(".import").find(".error-info").hide()});var W="SKIP";a(".import-btn").click(function(c){function d(){a(".confirm-info").hide()}c.preventDefault();var e=a(".import-field-dropdown"),f=e.length,g="",h=!1;e.each(function(){if(!h)for(var b=a(this).parent().index(),c=a(this).find(".btn-group-text").text(),d=b+1;f>d;d++)if(c==e.eq(d).find(".btn-group-text").text()&&c!=W){g=c,h=!0;break}});var i=a(this).closest(".back-tab").find(".confirm-info");if(h)i.text("Вы указали два столбца с одинаковым занчением : "+g).show();else{i.hide();var j,k=a(".import-dropdown .btn-group-text").text();switch(k){case"Продукты":j=com.vmesteonline.be.shop.bo.ImExType.IMPORT_PRODUCTS;break;case"Категории продуктов":j=com.vmesteonline.be.shop.bo.ImExType.IMPORT_CATEGORIES;break;case"Производители":j=com.vmesteonline.be.shop.bo.ImExType.IMPORT_PRODUCERS}var l=[],m=0;a(".import .import-field-dropdown").each(function(){var b=a(this).find(".btn-group-text").text();b!=W&&(l[m]=parseInt(a(this).find(".btn").data("fieldtype"))),m++});var n=new com.vmesteonline.be.shop.bo.ImportElement;n.type=j,n.filename="filename",n.fieldsMap=l,n.url=U;var o=[];o[0]=n;var p=new com.vmesteonline.be.shop.bo.DataSet;p.name="name",p.date=C,p.data=o,a(".loading").fadeIn(function(){try{b.clientBO.importData(p),i.text("Данные успешно импортированы.").addClass("info-good").show()}catch(c){i.text("Ошибка импорта.").show()}a(".loading").fadeOut(0),setTimeout(d,3e3)})}}),a(".export-orders-checklist select, .export-products-checklist select, .export-packs-checklist select").multiselect({noneSelectedText:"Опции",selectedText:"Опции (# выбрано)",checkAllText:"Выбрать все",uncheckAllText:"Отменить все"}),a(".ui-multiselect").addClass("btn btn-sm btn-info no-border"),a(".ui-multiselect .ui-icon").addClass("icon-caret-down"),a(".export .nav-tabs").find("li").click(function(){var b=a(this).index(),c=a(".export .tab-pane:eq("+b+")").addClass("active").height();z(c)}),a(".export-btn").click(function(c){c.preventDefault();var d=a(this).closest(".tab-pane"),e=d.find(".export-delivery-dropdown .btn-group-text").text(),f=d.find(".datepicker-export").attr("data-selectorderdate");if(f){d.find(".error-info").hide(),d.find(".confirm-info").hide();var g=a(".export .nav-tabs").find("li"),h=0;g.each(function(){a(this).hasClass("active")&&(h=a(this).index())});var i;i="Тип доставки"!=e&&"Все"!=e?j(e):0;var k;try{switch(h){case 0:var l=v("orders"),m=v("orderLine");k=b.clientBO.getTotalOrdersReport(f,i,l.fieldsMap,m.fieldsMap);var n;k.data&&(n=k.data.length,w(k,n,l,m));break;case 1:var o=v("products");k=b.clientBO.getTotalProductsReport(f,i,o.fieldsMap),k.data&&(n=k.data.length,w(k,n,o));break;case 2:o=v("packs"),k=b.clientBO.getTotalPackReport(f,i,o.fieldsMap),k.data&&(n=k.data.length,w(k,n,o))}r(),s(),k.data||d.find(".confirm-info").text("Нет данных на такое сочетание даты и типа доставки.").show(),z()}catch(c){d.find(".confirm-info").text("Ошибка экспорта.").show()}}else d.find(".error-info").text("Пожалуйста, укажите дату с заказом.").show()}),a(".nav-list a").click(function(b){b.preventDefault(),a(".back-tab").hide();var c=a(this).parent().index();switch(c){case 0:a(".back-orders").show();break;case 1:a(".import").show();break;case 2:a(".export").show()}a(this).closest("ul").find(".active").removeClass("active"),a(this).parent().addClass("active"),z()})});