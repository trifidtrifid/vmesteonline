require.config({baseUrl:"/build",paths:{jquery:"../js/lib/jquery-2.1.1.min",bootstrap:"../js/lib/bootstrap.min",ace_extra:"../js/lib/ace-extra.min",ace_elements:"../js/lib/ace-elements.min",jquery_ui:"../js/lib/jquery-ui-1.10.3.full.min",flexslider:"../js/lib/jquery.flexslider-min",ace_spinner:"../js/lib/fuelux/fuelux.spinner","datepicker-backoffice":"../js/shop/bootstrap-datepicker-backoffice","datepicker-ru":"../js/lib/date-time/locales/bootstrap-datepicker.ru",multiselect:"../js/lib/jquery.multiselect.min",bootbox:"../js/bootbox.min"},shim:{ace_spinner:{deps:["jquery","ace_extra","ace_elements","jquery_ui"],exports:"ace_spinner"},jquery_ui:{deps:["jquery"],exports:"jquery_ui"},bootstrap:{deps:["jquery"],exports:"bootstrap"},"datepicker-backoffice":{deps:["jquery","jquery_ui"],exports:"datepicker-backoffice"},"datepicker-ru":{deps:["jquery","datepicker-backoffice"],exports:"datepicker-ru"},flexslider:{deps:["jquery"],exports:"flexslider"},multiselect:{deps:["jquery","jquery_ui"],exports:"multiselect"},bootbox:{deps:["jquery","bootstrap"],exports:"bootbox"}}});var deliveryFilterFlag=0,statusFilterFlag=0,dateFilterFlag=0,searchFilterFlag=0,orders;require(["jquery","shop-initThrift.min","commonM.min","shop-orders.min","datepicker-backoffice","datepicker-ru","bootstrap","multiselect"],function(a,b,c,d){function e(b){try{var c=a(".main-content"),d=b?b:c.height(),e=H.height();d>e?(d=b?b+100:c.height()+45,a("#sidebar").css("height",d)):a("#sidebar").css("height",e)}catch(f){alert(f+" Функция setSidebarHeight")}}function f(){try{orders=b.client.getOrdersByStatus(0,J+180*K,0),a(".orders-list").html("").append(i(orders));var c=a(".orders-no-init");g(c),c.removeClass("orders-no-init"),deliveryFilterFlag=0,statusFilterFlag=0,dateFilterFlag=0,searchFilterFlag=0}catch(d){}}function g(c){c.find(".plus-minus").click(function(c){c.preventDefault();var e=a(this).closest(".order-item"),f=e.find(".order-products");if(0==f.find(".catalog").length){var g=e.data("orderid"),i=b.client.getOrderDetails(g);d.showOrderDetails(e,g,i),f.append(h(i))}f.slideToggle(200,function(){a(".main-content").height()>H.height()&&a("#sidebar, .shop-right").css("height",a(".main-content").height()+45)}),a(this).hasClass("fa-plus")?a(this).removeClass("fa-plus").addClass("fa-minus"):a(this).removeClass("fa-minus").addClass("fa-plus")})}function h(a){try{var c='<section class="catalog"><table><thead><tr><td>Название</td><td>Производитель</td><td>Цена (руб)</td><td>Количество</td><td>Стоимость</td><td>Ед.изм</td><td></td></tr></thead>',d=a.odrerLines,e=d.length;L=L?L:b.client.getProducers(),M=M?M:L.length;for(var f=0;e>f;f++){for(var g,h,i="",j=0;M>j;j++)if(L[j].id==d[f].product.producerId){g=L[j].name,h=L[j].id;break}d[f].product.unitName&&(i=d[f].product.unitName);var k;k=d[f].product.imageURL?d[f].product.imageURL:"i/no-photo.png",c+='<tr class="product" data-prepack="'+d[f].product.prepackRequired+'" data-productid="'+d[f].product.id+'"><td><a href="#" class="product-link"><div class="product-pic"><img src="'+k+'" alt="картинка"/></div><span><span class="product-name">'+d[f].product.name+"</span>"+d[f].product.shortDescr+'</span></a><div class="modal"></div></td><td class="td-producer" data-producerid="'+h+'">'+g+'</td><td class="product-price">'+d[f].product.price+'</td><td class="td-spinner">'+d[f].quantity+'</td><td class="orderLine-amount"><span>'+(d[f].product.price*d[f].quantity).toFixed(1)+'</span></td><td><span class="unit-name">'+i+"</span></td></tr>"}c+="</table></section>"}catch(l){alert(l+" Функция createOrdersProductHtml")}return c}function i(a,b){try{var c="",d=a.length,e=0,f=100;b&&(f=lengthOrders,d-=offsetOrders),d>f&&(e=d-f);for(var g=d-1;g>=e;g--){var h,i=new Date(1e3*a[g].date);switch(a[g].status){case 0:h="Неизвестен";break;case 1:h="Не подтвержден";break;case 2:h="Подтвержден";break;case 3:h="Уже едет";break;case 4:h="Доставлен";break;case 5:h="Закрыт";break;case 6:h="Отменен"}var j=i.getDate();j=10>j?"0"+j:j;var k=i.getMonth()+1;k=10>k?"0"+k:k;var l="";"Подтвержден"==h&&(l="passive"),c+='<div class="order-item orders-no-init" data-orderid="'+a[g].id+'"><table class="orders-tbl"><tbody><tr><td class="td1"><a class="fa fa-plus plus-minus" href="#"></a></td><td class="td2">'+a[g].id+'</td><td class="td8 user-name">'+a[g].userName+'</td><td class="td3" id="'+a[g].date+'">'+j+"."+k+"."+i.getFullYear()+'</td><td class="td4"><div class="order-status">'+h+'</div></td><td class="td9"></td><td class="td8"></td><td class="td6">'+a[g].totalCost.toFixed(1)+'</td><td class="td1"><a href="#" title="Удалить заказ" class="delete-order '+l+'">&times;</a></td></tr></tbody></table><div class="order-bottom"><div class="order-delivery"></div></div><div class="order-products"></div></div>'}}catch(m){alert(m+" Функция createOrdersHtml")}return c}function j(a){var b;switch(a){case"Подтвержден":b=2;break;case"Не подтвержден":b=1;break;case"Отменен":b=6}return b}function k(a){var b;switch(a){case"Самовывоз":b="1";break;case"Курьер рядом":b="2";break;case"Курьер далеко":b="3"}return b}function l(c){for(var d=[],e=0,f=c.length,g=a(".type-delivery-dropdown .btn-group-text").text(),h=k(g),i=0;f>i;i++){var j=b.client.getOrderDetails(c[i].id);h==j.delivery&&(d[e++]=c[i])}return d}function m(){try{var a=N.val().split("-"),b="",c=a[2];switch(a[1]){case"01":b="Jan";break;case"02":b="Feb";break;case"03":b="March";break;case"04":b="Apr";break;case"05":b="May";break;case"06":b="June";break;case"07":b="July";break;case"08":b="Aug";break;case"09":b="Sen";break;case"10":b="Oct";break;case"11":b="Nov";break;case"12":b="Dec"}}catch(d){alert(d+" Функция getMetaDate")}return Date.parse(a[0]+" "+b+" "+c)}function n(a){var b=parseInt(m()/1e3);b-=b%86400,b+=K;for(var c=a.length,d=[],e=0,f=0;c>f;f++)a[f].date==b&&(d[e++]=a[f]);return d}function o(){var b=a(".orders-no-init");g(b),b.removeClass("orders-no-init")}function p(b){var c=0,d=[],e=b.length,f=a(".status-dropdown .btn-group-text").text(),g=j(f);for(W=0;e>W;W++)g==b[W].status&&(d[c++]=b[W]);return d}function q(a){var c=b.client.getOrdersByStatus(0,J+180*K,0),d=r(c,a);return statusFilterFlag&&(d=p(d)),deliveryFilterFlag&&(d=l(d)),dateFilterFlag&&(d=n(d)),searchFilterFlag=1,d}function r(a,b){var c=a.length,d=[];S=0;for(var e=0;c>e;e++)-1!=a[e].userName.toLowerCase().indexOf(b.toLowerCase())&&(d[S++]=a[e]);return d}function s(){a(".show-full-text").click(function(b){if(b.preventDefault(),a(this).closest(".export-table").length>0)var c=b.pageX-330,d=b.pageY-90;else c=b.pageX-200,d=b.pageY-200;a(".full-text").hide(),a(this).parent().find(".full-text").css({left:c,top:d}).show()})}function t(){a(".full-text .close").click(function(b){b.preventDefault(),a(this).parent().hide()})}function u(a,b,c,d){for(var e="",f=a.length,g=c.length,h="",i=!1,j=0;g>j;j++)i||(h+='<li data-fieldtype="'+d[j]+'"><a href="#">'+c[j]+"</a></li>"),c[j]==bb&&(i=!0);for(i||(h+='<li data-fieldtype="-1"><a href="#">'+bb+"</a></li>"),j=0;f>j;j++)e+='<td><div class="btn-group import-field-dropdown"><button data-toggle="dropdown" data-fieldtype="'+b[j]+'" class="btn btn-info btn-sm dropdown-toggle no-border"><span class="btn-group-text">'+a[j]+'</span><span class="icon-caret-down icon-on-right"></span></button><ul class="dropdown-menu dropdown-blue">'+h+"</ul></div></td>";return e}function v(a,b){function c(a,b){for(var c,d="",e="",f=0;b>f;f++)e=a[f],e&&e.length>30&&(c=e,e=e.slice(0,30),e+=" <a class='show-full-text' href='#'>...</a>"+'<div class="full-text"><a href="#" class="close">×</a>'+c+"</div>"),d+="<td>"+e+"</td>";return d}for(var d="",e=a.length,f=0;e>f;f++)d+="<tr>"+c(a[f],b)+"</tr>";return d}function w(b){var c,d=[],e=0,f=[];S=0;var g=[],h=a(".ui-multiselect-menu:eq(0) .ui-multiselect-checkboxes li");switch(h.each(function(){a(this).hasClass("ui-multiselect-optgroup-label")&&(g[S++]=a(this).index())}),b){case"orders":var i=h.slice(g[0]+1,g[1]);c=i.find('input[aria-selected="true"]');break;case"orderLine":i=h.slice(g[1]+1),c=i.find('input[aria-selected="true"]');break;case"products":var j=a(".ui-multiselect-menu:eq(1) .ui-multiselect-checkboxes li");c=j.find('input[aria-selected="true"]');break;case"packs":var k=a(".ui-multiselect-menu:eq(2) .ui-multiselect-checkboxes li");c=k.find('input[aria-selected="true"]')}return S=0,c.each(function(){d[e++]=parseInt(a(this).val()),f[S++]=a(this).find("+span").text()}),{fieldsMap:d,headColArray:f}}function x(b,c,d,e){var f=a(".tab-pane.active").find(".export-table");f.html("");for(var g=[],h=c-1;h>=0;h--){g=[];for(var i=b.data[h].fieldsData,j=i.rowCount,k=Math.ceil(i.elems.length/j),l=0,m=0;j>m;m++){g[m]=[];for(var n=0;k>n;n++)g[m][n]=i.elems[l++]}var o,p=0;b.data[h].fieldsMap?(o=d.headColArray,e&&(o=h==c-1?d.headColArray:e.headColArray)):(o=g[0],p=1);var q='<div class="export-single-table"><table><thead><tr>'+y(o)+"</tr></thead><tbody>"+z(g,k,p)+"</tbody></table></div>";q+='<div class="report-link"><a href="'+b.data[h].url+'">Скачать отчет</a>',f.append(q)}}function y(a){var b="",c=a.length;for(W=0;c>W;W++)b+="<td>"+a[W]+"</td>";return b}function z(a,b,c){function d(a,b){for(var c,d="",e="",f=0;b>f;f++)e=a[f],e&&e.length>30&&(c=e,e=e.slice(0,30),e+=" <a class='show-full-text' href='#'>...</a>"+'<div class="full-text"><a href="#" class="close">×</a>'+c+"</div>"),d+="<td>"+e+"</td>";return d}for(var e="",f=a.length,g=c;f>g;g++)e+="<tr>"+d(a[g],b)+"</tr>";return e}function A(b){var c=document.createElement("div");c.appendChild(document.createElement("div")),c.style.overflow="auto",c.style.overflowY="hidden",c.firstChild.style.width=b.scrollWidth+"px",c.firstChild.style.paddingTop="1px",c.firstChild.style.marginTop="-5px",c.firstChild.appendChild(document.createTextNode(" ")),c.onscroll=function(){b.scrollLeft=c.scrollLeft},b.onscroll=function(){c.scrollLeft=b.scrollLeft},b.parentNode.insertBefore(c,b),a(b).prev().addClass("top-scroll")}function B(){function c(){var b,c="";b=e();for(var f,h=!1,i=1;b>=i;i++)f=g(i,h)?"disable":"",c+='<li class="'+f+'"><a href="#">'+i+"</a></li>";a(".shedule-item").each(function(){console.log("iter"),a(this).find(".delivery-day-dropdown .dropdown-menu").html(c)}),d(a(".delivery-day-dropdown a"))}function d(b){b.click(function(b){if(b.preventDefault(),!a(this).parent().hasClass("disable")){var d=a(this).text();a(this).closest(".btn-group").find(".btn-group-text").text(d),c()}})}function e(){var b;return b="неделя"==a(".delivery-period-dropdown .btn-group-text").text()?7:31}function f(a,b){var c,d="";c=e(),d+='<div class="shedule-item new-interval">',d+=0==n?'<a href="#" class="add-delivery-interval pull-right add-interval">+</a>':'<a href="#" class="add-delivery-interval pull-right remove-interval">&ndash;</a>',d+='<div class="shedule-confirm"><span>День доставки</span><div class="btn-group delivery-day-dropdown"><button data-toggle="dropdown" class="btn btn-info btn-sm dropdown-toggle no-border"><span class="btn-group-text">'+a.orderDay+'</span><span class="icon-caret-down icon-on-right"></span></button><ul class="dropdown-menu dropdown-blue">';var f,h;h=b?!1:!0;for(var i=1;c>=i;i++)f=g(i,h)?"disable":"",d+='<li class="'+f+'"><a href="#">'+i+"</a></li>";return d+='</ul></div></div><div class="shedule-confirm"><span>подтверждать заказ за</span><input type="text" class="days-before" value="'+a.orderBefore+'"><span>дня до доставки</span></div></div>'}function g(b,c){var d=!1;if(c){for(var e=0;l>e;e++)if(k[e].orderDay==b){d=!0;break}}else a(".shedule-item").each(function(){var c=a(this).find(".delivery-day-dropdown .btn-group-text").text();console.log(c+" "+b),c==b&&(console.log("!!!!"),d=!0)});return d}a("#settings-logo").ace_file_input({style:"well",btn_choose:"Изменить логотип",btn_change:null,no_icon:"",droppable:!0,thumbnail:"large",icon_remove:null}).on("change",function(){a(".logo-container>img").hide()}).parent().addClass("settings-logo"),a("#date-picker-6").datepicker({autoclose:!0,language:"ru"});for(var h,i=a(".backoffice.dynamic").attr("id"),j=b.client.getShop(i),k=b.clientBO.getDates(),l=k.length,m="",n=0;l>n;n++)h=k[n],m+=f(h);a(".delivery-period").after(m),d(a(".delivery-day-dropdown a")),a(".delivery-period-dropdown a").click(function(b){b.preventDefault();var c,e="";"неделя"==a(this).text()?c=7:"месяц"==a(this).text()&&(c=31);for(var f,h=!1,i=1;c>=i;i++)f=g(i,h)?"disable":"",e+='<li class="'+f+'"><a href="#">'+i+"</a></li>";a(".delivery-day-dropdown").each(function(){a(this).find(".dropdown-menu").html(e)}),d(a(".delivery-day-dropdown a"))});var o=j.deliveryCostByDistance,p="";for(var q in o)p+='<div class="delivery-interval delivery-price-type"><input type="text" value="'+q+'"><span>км</span><input type="text" value="'+o[q]+'"><span>руб</span><a href="#" class="add-delivery-interval add-interval">+</a></div>';""==p&&(p+='<div class="delivery-interval delivery-price-type"><input type="text" placeholder="Интервал"><span>км</span><input type="text" placeholder="Стоимость"><span>руб</span><a href="#" class="add-delivery-interval add-interval">+</a></div>'),a(".delivery-interval-container").append(p);var r=j.deliveryByWeightIncrement,s="";for(var q in r)s+='<div class="delivery-weight delivery-price-type"><input type="text" value="'+q+'"><span>кг</span><input type="text" value="'+r[q]+'"><span>руб</span><a href="#" class="add-delivery-interval add-interval">+</a></div>';""==s&&(s+='<div class="delivery-weight delivery-price-type"><input type="text" placeholder="Интервал"><span>кг</span><input type="text" placeholder="Стоимость"><span>руб</span><a href="#" class="add-delivery-interval add-interval">+</a></div>'),a(".delivery-weight-container").append(s);var t=j.deliveryTypeAddressMasks,u="";for(var q in t){var v;2==q?v="Близко":3==q&&(v="Далеко"),u+='<div class="delivery-area  delivery-price-type"><span>'+v+'</span><input type="text" value="'+t[q]+'"><span>руб</span></div>'}""==u&&(u+='<div class="delivery-area  delivery-price-type"><span>Близко</span><input type="text" placeholder="Стоимость"><span>руб</span></div><div class="delivery-area  delivery-price-type"><span>Далеко</span><input type="text" placeholder="Стоимость"><span>руб</span></div>'),a(".delivery-area-container").append(u);var w=j.deliveryCosts,x="";for(var q in w)v="",1==q?v="Самовывоз":2==q?v="Близко":3==q&&(v="Далеко"),x+='<div class="delivery-type  delivery-price-type"><span>'+v+'</span><input type="text" value="'+w[q]+'"><span>руб</span></div>';""==x&&(x+='<div class="delivery-type  delivery-price-type"><span>Близко</span><input type="text" placeholder="Стоимость"><span>руб</span></div><div class="delivery-type  delivery-price-type"><span>Далеко</span><input type="text" placeholder="Стоимость"><span>руб</span></div>'),a(".delivery-type-container").append(x),a(".add-interval").click(function(b){b.preventDefault();var d,h=a(this).closest(".delivery-price-type").hasClass("delivery-interval"),i=a(this).closest(".shedule-item").length;if(i){var j={};j.orderDay=1;for(var k=e(),l=!1,m=!0,n=1;k>n;n++)if(!g(n,l)){j.orderDay=n;break}j.orderBefore=2,a(this).closest("#settings-shedule").find(".shedule-item").last().after(f(j,m)),c()}else d=h?'<div class="delivery-interval new-interval delivery-price-type"><input type="text" placeholder="Интервал"><span>км</span>&nbsp;<input type="text" placeholder="Стоимость"><span>руб</span>&nbsp;<a href="#" class="add-delivery-interval remove-interval">&ndash;</a></div>':'<div class="delivery-weight new-interval delivery-price-type"><input type="text" placeholder="Интервал"><span>кг</span>&nbsp;<input type="text" placeholder="Стоимость"><span>руб</span>&nbsp;<a href="#" class="add-delivery-interval remove-interval">&ndash;</a></div>',a(this).closest(".delivery-price-type").after(d);a(".new-interval .remove-interval").click(function(b){b.preventDefault(),a(this).closest(".new-interval").slideUp(200,function(){a(this).detach()})}),a(".new-interval").slideDown().removeClass(".new-interval")}),a("#settings-shedule .remove-interval").click(function(b){b.preventDefault(),a(this).closest(".new-interval").slideUp(200,function(){a(this).detach()})}),a("#settings-delivery input").focus(function(){a(this).closest(".settings-delivery-container").addClass("changed")}),a(".settings-item .btn-save").click(function(c){c.preventDefault();var d=a(this).closest(".settings-item").attr("id");switch(d){case"settings-common":var e=a("#settings-common"),f=j;f.name=e.find(a("#name")).val(),f.descr=e.find(a("#descr")).val(),f.address=b.client.createDeliveryAddress(e.find(a("#address")).val());var g=a(".logo-container .file-name img");f.logoURL=g.length?g.css("background-image"):a(".logo-container>img").attr("src"),b.clientBO.updateShop(f);break;case"settings-shedule":var h=new com.vmesteonline.be.shop.OrderDates;h.type="неделя"==a(".delivery-period-dropdown .btn-group-text").text()?com.vmesteonline.be.shop.OrderDatesType.ORDER_WEEKLY:com.vmesteonline.be.shop.OrderDatesType.ORDER_MOUNTHLY,a(".shedule-item").each(function(){var c=a(this).find(".delivery-day-dropdown .btn-group-text").text(),d=a(this).find(".days-before").val();h.orderDay=parseInt(c),h.orderBefore=parseInt(d);for(var e=!1,f=[],g=0;l>g;g++)f[g]=!1,h.orderDay==k[g].orderDay&&h.orderBefore==k[g].orderBefore&&(e=!0,f[g]=!0);e||b.clientBO.setDate(h)});for(var i=a(".shedule-item").length,m=0;l>m;m++){for(var n=!0,o=0;i>o;o++){var p=a(".shedule-item:eq("+o+")"),q=p.find(".delivery-day-dropdown .btn-group-text").text(),r=p.find(".days-before").val();h.orderDay=parseInt(q),h.orderBefore=parseInt(r),h.orderDay==k[m].orderDay&&h.orderBefore==k[m].orderBefore&&(n=!1)}console.log(n),n&&b.clientBO.removeDate(k[m])}break;case"settings-delivery":f=j;var s=!1,t=!1,u=!1,v=!1;if(a("#settings-delivery").find(".changed").each(function(){a(this).hasClass("delivery-interval-container")&&(s=!0),a(this).hasClass("delivery-area-container")&&(t=!0),a(this).hasClass("delivery-weight-container")&&(u=!0),a(this).hasClass("delivery-type-container")&&(v=!0)}),s){var w=[];a(".delivery-interval").each(function(){var b=parseInt(a(this).find("input:eq(0)").val()),c=parseFloat(a(this).find("input:eq(1)").val());b&&c&&(w[b]=c)}),b.clientBO.setShopDeliveryCostByDistance(hb,w)}if(t){var x=[],y=0;a(".delivery-area").each(function(){var b;b=y?com.vmesteonline.be.shop.DeliveryType.SHORT_RANGE:com.vmesteonline.be.shop.DeliveryType.LONG_RANGE,y++;var c=a(this).find("input:eq(0)").val();c&&(x[b]=c)}),b.clientBO.setShopDeliveryTypeAddressMasks(hb,x)}if(u){var z=[];a(".delivery-weight").each(function(){var b=parseInt(a(this).find("input:eq(0)").val()),c=parseInt(a(this).find("input:eq(1)").val());b&&c&&(z[b]=c)}),b.clientBO.setShopDeliveryByWeightIncrement(hb,z)}if(v){var A=[];y=0,a(".delivery-type").each(function(){var b;switch(y){case 0:b=com.vmesteonline.be.shop.DeliveryType.SELF_PICKUP;break;case 1:b=com.vmesteonline.be.shop.DeliveryType.SHORT_RANGE;break;case 2:b=com.vmesteonline.be.shop.DeliveryType.LONG_RANGE}y++;var c=a(this).find("input:eq(0)").val();c&&(A[b]=c)}),b.clientBO.setDeliveryCosts(A)}}}),gb=1}function C(b,c,d,e){b.find(".dropdown-toggle").click(function(b){b.preventDefault();var f=a(this).closest("td").index(),g=0,h=0;c.find("table").find("td").each(function(){f>h&&(g+=a(this).width()),h++});var i=e||0;g-=c.scrollLeft()+i,a(this).parent().find(".dropdown-menu").css({left:g,top:d})})}function D(a){var b=ib,c=b.length,d="";if(a){for(var e,f=0;c>f;f++)b[f].id==a&&(e=b[f]);return e}for(var f=0;c>f;f++)d+='<li data-categoryid="'+b[f].id+'"><a href="#">'+b[f].name+"</a></li>";var g='<div class="btn-group categories-dropdown"><button data-toggle="dropdown" class="btn btn-info btn-sm dropdown-toggle no-border"><span class="btn-group-text">Добавить</span><span class="icon-caret-down icon-on-right"></span></button><ul class="dropdown-menu dropdown-blue">'+d+"</ul></div>";return g}function E(){function c(){function c(b,c){var d=new com.vmesteonline.be.shop.FullProductInfo;d.product=new com.vmesteonline.be.shop.Product,d.details=new com.vmesteonline.be.shop.ProductDetails,d.product.id=c?0:b.attr("id"),d.product.name=b.find(".product-name textarea").val(),d.product.shortDescr=b.find(".product-shortDescr textarea").val(),d.product.producerId=b.find(".product-producer").data("producerid");var e=b.find(".product-imageURL .file-name img");d.product.imageURL=e.length?e.css("background-image"):b.find(".product-imageURL>img").attr("src"),d.product.weight=b.find(".product-weight input").val()?parseFloat(b.find(".product-weight input").val()):0,d.product.price=b.find(".product-price input").val()?parseFloat(b.find(".product-price input").val()):0,d.product.unitName=b.find(".product-unitName input").val(),d.product.minClientPack=b.find(".product-pack input").val()?parseFloat(b.find(".product-pack input").val()):0,d.product.prepackRequired=b.find(".product-prepack input").attr("checked")?!0:!1,d.details.fullDescr=b.find(".product-fullDescr textarea").val();var f=0,g=b.find(".product-imagesSet").find(".file-name img").length;if(g){var h=[];b.find(".product-imagesSet .ace-file-input.added").each(function(){h[f++]=a(this).find(".file-name img").css("background-image")}),d.details.imagesURLset=h}f=0;var i=[];b.find(".product-categories .category-item").each(function(){i[f++]=a(this).data("categoryid")}),d.details.categories=i;var j=[];return b.find(".product-options table tr").each(function(){j[a(this).find("td:eq(0)").text()]=a(this).find("td:eq(1)").text()}),d.details.options=j,d}function j(){var c,j=a(".products-table>table");j.find("tbody tr").each(function(){var j=a(this).attr("id");c=b.client.getProductDetails(j);var l=c.imagesURLset,m=l.length,n="<div class='images-set'>";if(0!=m)for(var o=0;m>o;o++)n+="<div class='image-item map-item'><a href='#' class='remove-image-item remove-item'>&times</a><img src='"+l[o]+"'></div>";n+="</div><input type='file' id='imagesURLSet-"+j+"-"+m+"'>";for(var p=c.categories,q=p.length,r="",o=0;q>o;o++)r+="<div class='category-item map-item' data-categoryid='"+p[o]+"'><a href='#' class='remove-category-item remove-item'>&times</a>"+D(p[o]).name+"</div>";r+=jb;var s=c.optionsMap,t="<table><tbody>";for(var u in s)t+="<tr><td><input type='text' value='"+u+"'></td><td><input type='text' value='"+s[u]+"'></td><td class='td-remove-options'><a href='' class='remove-options-item remove-item'>&times;</a></td></tr>";t+="</tbody></table><a href='#' class='add-options-item add-item'>Добавить</a>";for(var v,w=a(this).find(".product-producer").data("producerid"),x=kb,y=x.length,z="",o=0;y>o;o++)x[o].id==w&&(v=x[o]),z+="<li data-producerid='"+x[o].id+"'><a href='#'>"+x[o].name+"</a></li>";var A="<span>"+v.name+'</span><div class="btn-group producers-dropdown"><button data-toggle="dropdown" class="btn btn-info btn-sm dropdown-toggle no-border"><span class="btn-group-text">Изменить</span><span class="icon-caret-down icon-on-right"></span></button><ul class="dropdown-menu dropdown-blue">'+z+"</ul></div>",B=a(this);a("#imageURL-"+j).ace_file_input({style:"well",btn_choose:"",btn_change:null,no_icon:"",droppable:!0,icon_remove:null,thumbnail:"large"}).on("change",function(){B.find(".product-imageURL .file-label").css("opacity",1),B.find(".product-imageURL>img").hide()}),a(this).find(".product-fullDescr textarea").val(c.fullDescr),a(this).find(".product-imagesSet").html(n),a("#imagesURLSet-"+j+"-"+m).ace_file_input({style:"well",btn_choose:"Добавить",btn_change:null,no_icon:"",droppable:!0,thumbnail:"large"}).on("change",function(){var b=a(this);e(j,m,b)}),d(a(this).find(".ace-file-input")),a(this).find(".product-categories").html(r),f(a(this)),g(a(this)),a(this).find(".product-options").html(t),h(a(this)),i(a(this)),a(this).find(".product-producer").html(A),k(a(this))})}function k(b){b.find(".producers-dropdown .dropdown-menu a").click(function(b){b.preventDefault();var c=a(this).text(),d=a(this).closest("li").data("producerid");a(this).closest("td").attr("id",d).find(">span").text(c)})}j(),A(document.getElementById("doublescroll-2")),a(".table-add-product .edit-add").click(function(d){d.preventDefault();var e=a(".backoffice.dynamic").attr("id"),f=a(this).closest(".table-add-product").find("table tr"),g=!0,h=c(f,g);h.product.producerId?(a(".error-info").hide(),b.clientBO.registerProduct(h,e),a(this).closest(".table-add-product").slideUp(function(){var b=f.clone();b.addClass("hidden"),a(".product-table table tbody").prepend(b),b.slideDown()})):a(".error-info").text("Вы не указали производителя !").show()}),a(".product-remove a").click(function(c){c.preventDefault();var d=a(this).closest("tr").attr("id"),e=a(".backoffice.dynamic").attr("id");a(this).closest("tr").addClass("removing").fadeOut(600,function(){a(this).detach()}),b.clientBO.deleteProduct(d,e)}),a(".save-products").click(function(d){d.preventDefault(),a("#edit-product table .changed").each(function(){var d=a(this),e=!1,f=c(d,e);b.clientBO.updateProduct(f)})}),a("#edit-product .products-table table tr,#edit-category .category-table tr, #edit-producer .producer-table tr").click(function(){a(this).addClass("changed")}),cb=1}function d(b){b.find(".remove").click(function(b){b.preventDefault(),a(this).closest(".ace-file-input").hide().detach()})}function e(b,c,f){if(!f.parent().hasClass("added")){f.parent().addClass("added"),c++;var g="<input type='file' class='new-input' id='imagesURLSet-"+b+"-"+c+"'>";f.parent().after(g),a("#imagesURLSet-"+b+"-"+c).ace_file_input({style:"well",btn_choose:"Добавить",btn_change:null,no_icon:"",droppable:!0,thumbnail:"large"}).on("change",function(){var d=a(this);e(b,c,d)}),d(f.parent())}}function f(b){b.find(".remove-category-item").click(function(b){b.preventDefault(),a(this).closest(".map-item").fadeOut(200)})}function g(b){b.find(".categories-dropdown .dropdown-menu a").click(function(b){b.preventDefault();var c='<div class="category-item map-item" data-categoryid="'+a(this).closest("li").data("categoryid")+'"><a href="#" class="remove-category-item remove-item">×</a>'+a(this).text()+"</div>";a(this).closest("td").find(".categories-dropdown").before(c),f(a(this).closest("td"))})}function h(b){b.find(".remove-options-item").click(function(b){b.preventDefault(),a(this).closest("tr").slideUp(200,function(){a(this).detach()})})}function i(b){b.find(".add-options-item ").click(function(b){b.preventDefault();var c='<tr><td><input type="text" value=""></td><td><input type="text" value=""></td><td class="td-remove-options"><a href="" class="remove-options-item remove-item">×</a></td></tr>';a(this).closest("td").find("table tbody").append(c),h(a(this).closest("td"))})}function j(){function c(a){var b=a.text(),c=a.closest("li").data("categoryid");a.closest(".category-parent").attr("data-parentid",c).find(".btn-group-text").text(b)}function d(a,b){var c=new com.vmesteonline.be.shop.ProductCategory;return c.id=b?0:a.attr("id"),c.name=a.find(".category-name textarea").val(),c.descr=a.find(".category-descr textarea").val(),c.parentId=a.find(".category-parent").attr("data-parentid"),c}a(".category-parent").each(function(){if(a(this).html(jb),a(this).find(".btn-group-text").text("Выбрать родительскую"),a(this).find(".dropdown-menu a").click(function(b){b.preventDefault(),c(a(this))}),0==a(this).closest(".table-add").length){var b=a(this).data("parentid");a(this).find(".dropdown-menu li").each(function(){a(this).data("categoryid")==b&&c(a(this))})}}),a(".table-add-category .edit-add").click(function(c){c.preventDefault();var e=a(".backoffice.dynamic").attr("id"),f=a(this).closest(".table-add-category").find("table tr"),g=!0,h=d(f,g);a(".error-info").hide(),b.clientBO.registerProductCategory(h,e),a(this).closest(".table-add-category").slideUp(function(){var b=f.clone();b.addClass("hidden"),a(".product-table table tbody").prepend(b),b.slideDown()})}),a(".save-categories").click(function(c){c.preventDefault(),a(".category-table tr.changed").each(function(){var c=a(this),e=!1,f=d(c,e);b.clientBO.updateCategory(f)})}),a(".category-remove a").click(function(c){c.preventDefault();var d=a(this).closest("tr").attr("id"),e=a(".backoffice.dynamic").attr("id");a(this).closest("tr").addClass("removing").fadeOut(600,function(){a(this).detach()}),b.clientBO.deleteCategory(d,e)}),db=1}function k(){function c(a,b){var c=new com.vmesteonline.be.shop.Producer;return c.id=b?0:a.attr("id"),c.name=a.find(".producer-name textarea").val(),c.descr=a.find(".producer-descr textarea").val(),c}a(".table-add-producer .edit-add").click(function(d){d.preventDefault();var e=a(".backoffice.dynamic").attr("id"),f=a(this).closest(".table-add-producer").find("table tr"),g=!0,h=c(f,g);a(".error-info").hide(),b.clientBO.registerProducer(h,e),a(this).closest(".table-add-producer").slideUp(function(){var b=f.clone();b.addClass("hidden"),a(".product-table table tbody").prepend(b),b.slideDown()})}),a(".save-producers").click(function(d){d.preventDefault(),a(".producer-table tr.changed").each(function(){var d=a(this),e=!1,f=c(d,e);b.clientBO.updateProducer(f)})}),a(".producer-remove a").click(function(c){c.preventDefault();var d=a(this).closest("tr").attr("id"),e=a(".backoffice.dynamic").attr("id");a(this).closest("tr").addClass("removing").fadeOut(600,function(){a(this).detach()}),b.clientBO.deleteProducer(d,e)}),eb=1}cb||c(),fb||(a(".edit-show-add").click(function(b){b.preventDefault(),a(this).find("+.table-add").slideToggle();var c=a(this).closest(".tab-pane").attr("id");switch(c){case"edit-product":var j=a(".table-add-product table tr");a("#imageURL-add").ace_file_input({style:"well",btn_choose:"",btn_change:null,no_icon:"",droppable:!0,icon_remove:null,thumbnail:"large"}).on("change",function(){j.find(".product-imageURL .file-label").css("opacity",1),j.find(".product-imageURL>img").hide()}),a("#imageURLSet-add").ace_file_input({style:"well",btn_choose:"Добавить изображение",btn_change:null,no_icon:"",droppable:!0,thumbnail:"large"}).on("change",function(){var b=a(this);e(0,0,b)}),d(a(".table-add-product table .product-imagesSet"));var k=jb,l=a(".table-add-product .product-categories");l.html(k),f(l),g(l);var m=a(".table-add-product .table-overflow");C(m.find(".categories-dropdown"),m,84);var n=a(".table-add-product .product-options");h(n),i(n),C(m.find(".producers-dropdown"),m,84),a(this).find("+.table-add .product-producer .dropdown-menu a").click(function(){var b=a(this).parent().data("producerid");a(this).closest("td").attr("data-producerid",b)});break;case"edit-category":break;case"edit-producer":}}),a(".bo-edit .nav-tabs a").click(function(){var b=a(this).parent().index();switch(b){case 1:db||j();break;case 2:eb||k()}})),fb=1}function F(a,c){var d,e=b.userClient.getUserContactsExt(a);d=c?"; ":"<br>";var f="Email: "+e.email;return e.mobilePhone?f+=d+" Телефон: "+e.mobilePhone:!1,e.homeAddress?f+=d+" Адрес: "+e.homeAddress.street.name+" "+e.homeAddress.building.fullNo+", "+e.homeAddress.flatNo:!1,f}function G(a,b){a.find("span").text(b.firstName+" "+b.lastName),a.closest("tr").find(".owner-contacts").html(F(b.id))}var H=a(window);if(a(".container.backoffice").hasClass("noAccess"))bootbox.alert("У вас нет прав доступа !",function(){document.location.replace("./shop.jsp")});else if(a(".backoffice.dynamic").hasClass("adminka")){var I=a("body").height();e(I),a(".adminka-shops table tr").each(function(){var c=a(this).attr("id"),d=b.client.getShop(c),e=b.userClient.getUserInfoExt(d.ownerId),f=F(d.ownerId);a(".owner-name span").text(e.firstName+" "+e.lastName),a(".owner-contacts").html(f)}),a(".update-owner-link").click(function(c){c.preventDefault();var d="<div class='update-owner-line'><input type='text' class='owner-email' placeholder='email нового владельца'><a href='#' class='btn btn-sm no-border btn-primary btn-update'>Изменить</a></div>",e=a(this).closest("td");0==e.find(".update-owner-line").length&&e.append(d),e.find(".update-owner-line").slideToggle(),e.find(".btn-update").one("click",function(c){c.preventDefault();var d=a(this).closest("tr").attr("id"),f=a(this).closest("td").find(".owner-email").val(),g=b.clientBO.setUserShopRole(d,f,3);e.find(".update-owner-line").slideToggle(),G(e,g)})}),a(".adminka .nav-list a").click(function(b){b.preventDefault(),a(".back-tab").hide();var c=a(this).parent().index();switch(c){case 0:a(".adminka-shops").show();
break;case 1:a(".adminka-users").show()}a(this).closest("ul").find(".active").removeClass("active"),a(this).parent().addClass("active")})}else{c.init();var J=parseInt((new Date).getTime()/1e3);J-=J%86400;var K=86400;f();var L,M;a(".delete-order").click(function(c){if(c.preventDefault(),!a(this).hasClass("passive")){var d=a(this).closest(".order-item"),e=d.data("orderid");b.client.deleteOrder(e),d.slideUp()}});try{var N=a("#date-picker-1"),O=a(".datepicker-export");globalUserAuth=!0,N.datepicker({autoclose:!0,language:"ru"}).next().on(ace.click_event,function(){a(this).prev().focus()}),O.datepicker({autoclose:!0,language:"ru"}).next().on(ace.click_event,function(){a(this).prev().focus()});var P={createOrdersHtml:i,initOrderPlusMinus:g,setSidebarHeight:e,filterByStatus:p,filterByDelivery:l,filterBySearch:r};N.datepicker("setVarOrderDates",P),O.datepicker("setVarOrderDates",P),a(".reset-filters").click(function(){f(),a(".type-delivery-dropdown .btn-group-text").text("Тип доставки"),a(".status-dropdown .btn-group-text").text("Статус заказа"),a("#back-search").val("Поиск по имени клиента или номеру телефона"),N.val("Фильтр по дате")})}catch(Q){}a("#date-picker-2,#date-picker-3,#date-picker-4").val("Фильтр по дате"),a(".export .checkbox input.ace").prop("checked",!1),a(".status-dropdown .dropdown-menu li").click(function(c){c.preventDefault();var d=a(this).find("a").text(),e=j(d),f=b.client.getOrdersByStatus(0,J+180*K,e);deliveryFilterFlag&&(f=l(f)),searchFilterFlag&&(f=r(f,a("#back-search").val())),dateFilterFlag&&(f=n(f)),a(".orders-list").html("").append(i(f)),o(),statusFilterFlag=1}),a(".type-delivery-dropdown .dropdown-menu li").click(function(c){c.preventDefault();var d=b.client.getOrdersByStatus(0,J+180*K,0),e=l(d);statusFilterFlag&&(e=p(e)),searchFilterFlag&&(e=r(e,a("#back-search").val())),dateFilterFlag&&(e=n(e)),a(".orders-list").html("").append(i(e)),o(),deliveryFilterFlag=1});var R=[],S=0;a(".back-orders .order-item").each(function(){R[S++]=a(this).find(".user-name").text()});var T=R.length,U=[],V=0;S=0;for(var W=0;T-1>W;W++){V=0;for(var X=W+1;T>X;X++)R[W]==R[X]&&(V=1);V||(U[S++]=R[W])}U[S]=R[T-1],a("#back-search").focus(function(){a(this).autocomplete({source:U,select:function(b,c){a(".orders-list").html("").append(i(q(c.item.label))),o()}})}),a(".search-form").submit(function(b){b.preventDefault();var c=a("#back-search").val();a(".orders-list").html("").append(i(q(c))),o()});var Y,Z,$,_,ab=[];a(".form-import").submit(function(c){c.preventDefault();var d=a("#import-data").val();if("Тип импортируемых данных"==a(".import-dropdown .btn-group-text").text())a(".import").find(".error-info").text("Пожалуйста, укажите тип импортируемых данных.").show();else if(d){{a("#import-public").val()}d=d.split("\\");var e=d.length,f=(d[e-1],new FormData),g=a(".form-import #import-data");f.append("data",g[0].files[0]),a.ajax({type:"POST",url:"/file/",cache:!1,processData:!1,contentType:!1,data:f,success:function(c){_=c;var d=b.clientBO.parseCSVfile(_);Y=d.elems,Z=d.rowCount;var e=Y.length;$=e/Z;var f=0;ab=[];for(var g=0;Z>g;g++){ab[g]=[];for(var h=0;$>h;h++)ab[g][h]=Y[f++]}var i=a(".import-dropdown .btn-group-text").text(),j=[],k=[],l=com.vmesteonline.be.shop.bo.ExchangeFieldType;switch(f=0,i){case"Продукты":for(var m in l)l[m]>=300&&l[m]<330&&(j[f]=m,k[f++]=l[m]);break;case"Категории продуктов":for(m in l)l[m]>=200&&l[m]<230&&(j[f]=m,k[f++]=l[m]);break;case"Производители":for(m in l)l[m]>=100&&l[m]<130&&(j[f]=m,k[f++]=l[m])}var n,o,p=j.slice(0),q=k.slice(0);if(f>$)for(n=f,o=$,g=n-1;g>=o;g--)j.pop(),k.pop();if($>f)for(n=$,o=f,g=n-1;g>=o;g--)j[g]=bb,k[g]=-1;var r="<table><thead><tr>"+u(j,k,p,q)+"</tr></thead><tbody>"+v(ab,j.length)+"</tbody></table>";a(".import-table").html("").prepend(r).parent().show(),a(".top-scroll").remove(),A(document.getElementById("doublescroll")),s(),t(),a(".import-field-dropdown .dropdown-toggle").click(function(b){b.preventDefault();var c=a(this).closest("td").index(),d=0,e=0;a(".import-table table").find("td").each(function(){c>e&&(d+=a(this).width()),e++}),d-=a(".import-table").scrollLeft();var f=94;a(this).parent().find(".dropdown-menu").css({left:d,top:f})}),a(".import-field-dropdown .dropdown-menu").find("li a").click(function(b){b.preventDefault();var c=a(this).parent().text(),d=a(this).parent().data("fieldtype");a(".import-field-dropdown").each(function(){a(this).find(".btn-group-text").text()==c&&(a(this).find(".dropdown-toggle").attr("data-fieldtype",-1),a(this).find(".btn-group-text").text(bb))});var e=a(this).closest(".import-field-dropdown");e.find(".btn-group-text").text(c).parent().data("fieldtype",d)})}})}else a(".import").find(".error-info").text("Пожалуйста, выберите файл.").show()}),a("#import-data").click(function(){a(".import").find(".error-info").hide()}),a(".checkbox .lbl").click(function(){a(this).closest(".checkbox").toggleClass("active")}),a(".import-dropdown .dropdown-menu li").click(function(){a(".import").find(".error-info").hide()});var bb="SKIP";a(".import-btn").click(function(c){function d(){a(".confirm-info").hide()}c.preventDefault();var e=a(".import-field-dropdown"),f=e.length,g="",h=!1;e.each(function(){if(!h)for(var b=a(this).parent().index(),c=a(this).find(".btn-group-text").text(),d=b+1;f>d;d++)if(c==e.eq(d).find(".btn-group-text").text()&&c!=bb){g=c,h=!0;break}});var i=a(this).closest(".back-tab").find(".confirm-info");if(h)i.text("Вы указали два столбца с одинаковым занчением : "+g).show();else{i.hide();var j,k=a(".import-dropdown .btn-group-text").text();switch(k){case"Продукты":j=com.vmesteonline.be.shop.bo.ImExType.IMPORT_PRODUCTS;break;case"Категории продуктов":j=com.vmesteonline.be.shop.bo.ImExType.IMPORT_CATEGORIES;break;case"Производители":j=com.vmesteonline.be.shop.bo.ImExType.IMPORT_PRODUCERS}var l=[],m=0;a(".import .import-field-dropdown").each(function(){var b=a(this).find(".btn-group-text").text();b!=bb&&(l[m]=parseInt(a(this).find(".btn").data("fieldtype"))),m++});var n=new com.vmesteonline.be.shop.bo.ImportElement;n.type=j,n.filename="filename",n.fieldsMap=l,n.url=_;var o=[];o[0]=n;var p=new com.vmesteonline.be.shop.bo.DataSet;p.name="name",p.date=J,p.data=o,a(".loading").fadeIn(function(){try{b.clientBO.importData(p),i.text("Данные успешно импортированы.").addClass("info-good").show()}catch(c){i.text("Ошибка импорта.").show()}a(".loading").fadeOut(0),setTimeout(d,3e3)})}}),a(".export-orders-checklist select, .export-products-checklist select, .export-packs-checklist select").multiselect({noneSelectedText:"Опции",selectedText:"Опции (# выбрано)",checkAllText:"Выбрать все",uncheckAllText:"Отменить все"}),a(".ui-multiselect").addClass("btn btn-sm btn-info no-border"),a(".ui-multiselect .ui-icon").addClass("icon-caret-down"),a(".export .nav-tabs").find("li").click(function(){var b=a(this).index(),c=a(".export .tab-pane:eq("+b+")").addClass("active").height();e(c)}),a(".export-btn").click(function(c){c.preventDefault();var d=a(this).closest(".tab-pane"),f=d.find(".export-delivery-dropdown .btn-group-text").text(),g=d.find(".datepicker-export").attr("data-selectorderdate");if(g){d.find(".error-info").hide(),d.find(".confirm-info").hide();var h=a(".export .nav-tabs").find("li"),i=0;h.each(function(){a(this).hasClass("active")&&(i=a(this).index())});var j;j="Тип доставки"!=f&&"Все"!=f?k(f):0;var l;try{switch(i){case 0:var m=w("orders"),n=w("orderLine");l=b.clientBO.getTotalOrdersReport(g,j,m.fieldsMap,n.fieldsMap);var o;l.data&&(o=l.data.length,x(l,o,m,n));break;case 1:var p=w("products");l=b.clientBO.getTotalProductsReport(g,j,p.fieldsMap),l.data&&(o=l.data.length,x(l,o,p));break;case 2:p=w("packs"),l=b.clientBO.getTotalPackReport(g,j,p.fieldsMap),l.data&&(o=l.data.length,x(l,o,p))}s(),t(),l.data||d.find(".confirm-info").text("Нет данных на такое сочетание даты и типа доставки.").show(),e(0)}catch(c){d.find(".confirm-info").text("Ошибка экспорта.").show()}}else d.find(".error-info").text("Пожалуйста, укажите дату с заказом.").show()}),a(".container.backoffice .nav-list a").click(function(b){b.preventDefault(),a(".back-tab").hide();var c=a(this).parent().index();switch(c){case 0:a(".back-orders").show();break;case 1:a(".bo-edit").show(),fb||E();break;case 2:a(".export").show();break;case 3:a(".import").show();break;case 4:a(".bo-settings").show(),gb||B()}a(this).closest("ul").find(".active").removeClass("active"),a(this).parent().addClass("active"),e()});var cb=0,db=0,eb=0,fb=0,gb=0,hb=a(".backoffice.dynamic").attr("id"),ib=b.client.getAllCategories(hb),jb=D(),kb=b.client.getProducers()}});